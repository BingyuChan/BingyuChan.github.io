<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>miaosha | BingyuChan的博客</title><meta name="description" content="秒杀系统一、学习目标 了解秒杀的业务 掌握秒杀的设计思路及技术架构 掌握SpringCloud针对于秒杀业务的应用 掌握redis对于性能的提升作用 掌握RabbitMQ对于业务拆分异步的处理应用  二、了解秒杀的业务及使用的技术架构2.1. 什么是秒杀【秒杀】一词在网络的最早起源，应该要追溯到日本的综合格斗技团体Pancrase在1993年9月21日发行的WEEKLY PRO-WRESTLING"><meta property="og:type" content="article"><meta property="og:title" content="miaosha"><meta property="og:url" content="https://bingyuchan.github.io/2021/01/07/miaosha/index.html"><meta property="og:site_name" content="My Blog"><meta property="og:description" content="秒杀系统一、学习目标 了解秒杀的业务 掌握秒杀的设计思路及技术架构 掌握SpringCloud针对于秒杀业务的应用 掌握redis对于性能的提升作用 掌握RabbitMQ对于业务拆分异步的处理应用  二、了解秒杀的业务及使用的技术架构2.1. 什么是秒杀【秒杀】一词在网络的最早起源，应该要追溯到日本的综合格斗技团体Pancrase在1993年9月21日发行的WEEKLY PRO-WRESTLING"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/sign.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/%E6%9E%B6%E6%9E%84.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redis.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/RabbitMQ.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/databaseTable.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/databaseTable1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisinstall1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisinstall2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisinstall3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisinstall4.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisinstall5.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisinstall6.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisproperties1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisproperties2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisproperties3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisproperties4.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisproperties5.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisproperties6.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/redisproperties7.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/rabbitinstall1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/rabbitinstall2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/rabbitinstall3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/rabbitinstall4.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/rabbitinstall5.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/rabbitinstall6.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/rabbitinstall7.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/RabbitMQ-path.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/RabbitMQ-path2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/RabbitMQ-path3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/RabbitMQ-path4.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/RabbitMQ-path5.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/%E7%9B%AE%E5%BD%95.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/EurekaServer.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/EurekaServer2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/assets%5CEurekaServer3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/EurekaServer4.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/Mavenimport.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/MavenImport1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/error.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/EurekaServer5.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/MavenImport.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/getTime.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyouStock1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyouStock2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyouStock3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyouStock4.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/MavenImport.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyoustockerror1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyoustockerror2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyouStock5.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/SSH%E6%B5%81%E7%A8%8B.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/IStockService.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/IStockService1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/getStockList.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/getStockBySKU1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/getStockBySKU2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/limitpolicy.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/insertLimitpolicy.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/tb_stock_storage.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/EurekaServer.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/eurekaStorage1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyouStock3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/eurekaStorage2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/MavenImport.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/eurekaStorage3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/insertStorage1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/insertStorage2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/insertStorage3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/storagequeue1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/MavenImport.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/MavenImport.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/orderqueue1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/createOrder.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/createOrder1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/getorder.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/MavenImport.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/zuul1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/zuul2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/EurekaServer.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyouClient1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyouClient2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/leyouClient3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/MavenImport.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/eurekaClient.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/webhtml.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/EurekaServer.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/eurekaconfig1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/eurekaconfig2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/eurekaconfig3.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/MavenImport.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/configserver.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/configserver1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/configtest1.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/configtest2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/limitpolicyPage.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/limitpolicyPage2.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/login.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/stocklist.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/stockpage.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/createorderpage.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/paypage.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/paysuccess.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/orderqueue.png"><meta property="og:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/storagequeue.png"><meta property="article:published_time" content="2021-01-07T02:16:04.000Z"><meta property="article:modified_time" content="2021-01-07T02:17:37.643Z"><meta property="article:author" content="BingyuChan"><meta property="article:tag" content="程序猿，Java"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bingyuchan.github.io/2021/01/07/miaosha/sign.png"><link rel="canonical" href="https://bingyuchan.github.io/2021/01/07/miaosha/index.html"><link rel="alternate" href="/atom.xml" title="My Blog" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.3.0"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/BingyuChan" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.png" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">BingyuChan</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Web Developer &amp; Designer</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Hangzhou, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-books"><a href="/books"><i class="icon icon-book-fill"></i> <span class="menu-title">书单</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/BingyuChan" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/null" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="/null" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="/null" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">8</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2021/01/20/JVM/" class="title">JVM</a></p><p class="item-date"><time datetime="2021-01-20T06:50:55.000Z" itemprop="datePublished">2021-01-20</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2021/01/20/Java%E9%9D%A2%E8%AF%95%E5%9F%BA%E7%A1%80/" class="title">Java面试基础</a></p><p class="item-date"><time datetime="2021-01-20T06:49:50.000Z" itemprop="datePublished">2021-01-20</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2021/01/18/Redis%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-Linux/" class="title">Redis集群搭建(Linux)</a></p><p class="item-date"><time datetime="2021-01-18T05:09:22.000Z" itemprop="datePublished">2021-01-18</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2021/01/07/miaosha/" class="title">miaosha</a></p><p class="item-date"><time datetime="2021-01-07T02:16:04.000Z" itemprop="datePublished">2021-01-07</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2021/01/06/photo/" class="title">photo</a></p><p class="item-date"><time datetime="2021-01-06T04:16:45.000Z" itemprop="datePublished">2021-01-06</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-miaosha" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">miaosha</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2021/01/07/miaosha/" class="article-date"><time datetime="2021-01-07T02:16:04.000Z" itemprop="datePublished">2021-01-07</time> </a></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/01/07/miaosha/#comments" class="article-comment-link">评论</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h1 id="秒杀系统"><a href="#秒杀系统" class="headerlink" title="秒杀系统"></a>秒杀系统</h1><h1 id="一、学习目标"><a href="#一、学习目标" class="headerlink" title="一、学习目标"></a>一、学习目标</h1><ul><li>了解秒杀的业务</li><li>掌握秒杀的设计思路及技术架构</li><li>掌握SpringCloud针对于秒杀业务的应用</li><li>掌握redis对于性能的提升作用</li><li>掌握RabbitMQ对于业务拆分异步的处理应用</li></ul><h1 id="二、了解秒杀的业务及使用的技术架构"><a href="#二、了解秒杀的业务及使用的技术架构" class="headerlink" title="二、了解秒杀的业务及使用的技术架构"></a>二、了解秒杀的业务及使用的技术架构</h1><h2 id="2-1-什么是秒杀"><a href="#2-1-什么是秒杀" class="headerlink" title="2.1. 什么是秒杀"></a>2.1. 什么是秒杀</h2><p>【秒杀】一词在网络的最早<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%B5%B7%E6%BA%90/6234970">起源</a>，应该要追溯到日本的综合格斗技团体Pancrase在1993年9月21日发行的<em>WEEKLY PRO-WRESTLING</em>（每周职业摔跤）杂志中出现的自创词，在2000年发行的一款回合制<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F/59904">网络游戏</a>【石器时代】传入中国并被发扬光大。</p><p>【石器时代】在战斗时会出现【<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%90%88%E5%87%BB/1273852">合击</a>】现象，就算大家敏捷素质不同，在倒计时28秒时，同时选择攻击一个目标，也会极大概率发动攻击群殴一个目标。特别是在玩家的PK战，经常出现群体合击或者人宠合击，造成强大的杀伤，瞬间打飞或者打晕对手。</p><p>由于游戏战斗采用的是倒计时模式，强大的杀伤往往只在一秒没过就结束，所以这类瞬间或几下击败对手就被称作：【秒杀】</p><p>到后来演化渐变成通俗用语，甚至用来替代一些暴力词汇：</p><p>“小心我秒你”；“昨天PK遇到高手，我被秒了”；“lj快走，不然秒你”；“终于120级，转生可以秒机暴啦”等等。</p><p>并在之后的【传奇】【<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/MU">MU</a>】【<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/CS/40539">CS</a>】等各种经典游戏中广为流传。直至被商家<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BF%83%E9%94%80%E6%B4%BB%E5%8A%A8/7354496">促销活动</a>所用。</p><p>所谓“秒杀”，是网上竞拍的一种新方式，就是网络<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%8D%96%E5%AE%B6">卖家</a>发布一些超低价格的商品，所有买家在同一时间网上抢购的一种销售方式。通俗一点讲就是网络商家为促销等目的组织的网上限时抢购活动。由于商品价格低廉，往往一上架就被抢购一空，有时只用一秒钟。2011年以来，在淘宝等大型购物网站中，“<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%A7%92%E6%9D%80%E5%BA%97">秒杀店</a>”的发展可谓迅猛。</p><p>对于商家来说，按照商家的规模，秒杀分为三种形式：</p><p>1、平台要求准时准点做秒杀，类似于天猫双11，11月11日0点开始抢购，或者京东的整点抢购，都由平台发起。</p><p>2、商家对于自己的店铺做秒杀，一般是厂家的旗舰店，在平台首页占据有利广告位，进入店铺做秒杀。</p><p>3、微信公众号链接网页做秒杀，由公众号运营的商家发起。</p><p>按照商家的促销活动内容，秒杀分为三种方式：</p><p>1、限价秒杀：最常见的秒杀形式，秒杀价格绝对低到令人无法相信也无法抗拒而不去参与，此种秒杀一般在开始之后1-3秒之内就会秒杀完毕。</p><p>2、低价限量秒杀：此种形式也可以理解为低折扣秒杀，限量不限时，秒完即止，此种秒杀形式商家提供一定数量的商品，直至秒完即止。</p><p>3、低价限时限量秒杀：此种形式也可以理解为低折扣秒杀，限时限量，在规定的时间内，无论商品是否秒杀完毕，该场秒杀都会结束。</p><h2 id="2-2-秒杀的业务特点"><a href="#2-2-秒杀的业务特点" class="headerlink" title="2.2. 秒杀的业务特点"></a>2.2. 秒杀的业务特点</h2><p>1、瞬时并发量大：大量用户会在同一时间抢购，网站流量瞬间激增。</p><p>2、库存少：一般都是低价限量，而访问的数量远远大于库存数量，只有极少数人成功。</p><p>3、业务流程简单：流程短，立即购买，下订单，减库存。</p><p>4、前期预热：对于还未开启活动的秒杀商品，以倒计时的方式显示，只能访问不能下单。</p><h2 id="2-3-设计思路"><a href="#2-3-设计思路" class="headerlink" title="2.3. 设计思路"></a>2.3. 设计思路</h2><p><img src="/2021/01/07/miaosha/sign.png" alt="sign.png"></p><p>1、限流：只能让秒杀成功的一小部分人进入到后台，和数据库进行交互，来减少数据库服务器的压力。</p><p>2、缓存：将部分业务逻辑写到缓存里，例如：商品限购数量、秒杀政策等。</p><p>3、异步：将业务逻辑拆分，减少服务器压力，例如：正常业务流程是下订单、付款、减库存同一时间完成，秒杀时可以将业务逻辑拆分。</p><p>4、预热：商家进行宣传，并提前设置好秒杀的商品、秒杀时间、限购数量，将设置的商品写入 redis 缓存。</p><p>5、展示：页面分为两层，第一层是商品列表页，第二层是商品详情页，通过商品列表页链接进入商品详情页，秒杀开始前，展示商品秒杀倒计时，不允许操作提交订单，只允许查看商品详情。秒杀开始时，展示商品秒杀到期时间。</p><p>6、提交订单：秒杀提交完订单将 redis 缓存里的数量减少，并提示支付。</p><p>7、队列操作：当支付成功之后，将秒杀成功详情写入 rabbitMQ，订单服务进行监听接收消息写入订单，库存服务进行监听接收消息减少库存。</p><p>8、时间服务器：页面服务端通过负载进行布署，各服务器时间可能会不一致，因此增加时间服务，来提供统一的时间。</p><h2 id="2-4-技术架构"><a href="#2-4-技术架构" class="headerlink" title="2.4. 技术架构"></a>2.4. 技术架构</h2><p><img src="/2021/01/07/miaosha/%E6%9E%B6%E6%9E%84.png" alt="架构"></p><p>整体架构图：</p><p>Eureka Client：</p><p>时间服务（leyouTimeServer，端口号8000）：为页面服务提供时间统一的接口。</p><p>商品服务（leyouStock，端口号7000）：对外提供的接口（商品列表、商品详情、秒杀政策）。</p><p>库存服务（leyouStorage，端口号6001）：队列监听，在队列中提取消息与数据库交互减少库存。</p><p>会员服务（leyouUser，端口号5000）：为页面服务提供会员数据接口，会员的添加、修改、登录。</p><p>订单服务（leyouOrder，端口号4000）：队列监听，在队列中提取消息与数据库交互生成订单。</p><p>页面服务（leyouClient，端口号3000）：为前端页面提供数据接口。</p><p>Eureka Server：</p><p>注册中心（leyouServer，端口号9000）各服务都在注册中心进行注册。</p><p>配置中心 （leyouConfig）：提供所有服务需要的配置。</p><p>Redis的应用：</p><p><img src="/2021/01/07/miaosha/redis.png" alt="redis"></p><p>缓存商品数量、秒杀政策。</p><p>商家对秒杀政策、商品限量进行设置，设置完成写入Redis。</p><p>消费者访问商品详情，提交订单之后，从Redis中减少商品数量。</p><p>Redis里存取内容：</p><p>1、在政策新增的时候存入，key的值为：LIMIT_POLICY_{sku_id}，value的值为政策内容</p><p>2、商品列表取数据时，通过key（LIMIT_POLICY_{sku_id}），取出政策内容。</p><p>3、政策到期之后，自动删除。</p><p>RabbitMQ的应用：</p><p><img src="/2021/01/07/miaosha/RabbitMQ.png" alt="RabbitMQ"></p><p>消费者提交订单，自动写入订单队列：</p><p>订单队列：订单服务监听订单队列，接收到消息之后将队列信息写入数据库订单表。</p><p>消费者付款之后，更新订单状态，更新成功之后写入库存队列</p><p>库存队列：库存服务监听库存队列，接收到消息之后将库存信息写入数据库减少库存。</p><h2 id="2-5-数据库结构"><a href="#2-5-数据库结构" class="headerlink" title="2.5. 数据库结构"></a>2.5. 数据库结构</h2><p><img src="/2021/01/07/miaosha/databaseTable.png" alt="databaseTable.png"></p><p><img src="/2021/01/07/miaosha/databaseTable1.png" alt="databaseTable1.png"></p><h1 id="三、秒杀环境搭建（了解）"><a href="#三、秒杀环境搭建（了解）" class="headerlink" title="三、秒杀环境搭建（了解）"></a>三、秒杀环境搭建（了解）</h1><h2 id="3-1-安装redis及配置"><a href="#3-1-安装redis及配置" class="headerlink" title="3.1. 安装redis及配置"></a>3.1. 安装redis及配置</h2><h3 id="3-1-1-安装redis"><a href="#3-1-1-安装redis" class="headerlink" title="3.1.1. 安装redis"></a>3.1.1. 安装redis</h3><p><img src="/2021/01/07/miaosha/redisinstall1.png" alt="redisinstall1.png"></p><p><img src="/2021/01/07/miaosha/redisinstall2.png" alt="redisinstall2.png"></p><p><img src="/2021/01/07/miaosha/redisinstall3.png" alt="redisinstall3.png"></p><p><img src="/2021/01/07/miaosha/redisinstall4.png" alt="redisinstall4.png"></p><p><img src="/2021/01/07/miaosha/redisinstall5.png" alt="redisinstall5.png"></p><p><img src="/2021/01/07/miaosha/redisinstall6.png" alt="redisinstall6.png"></p><h3 id="3-1-2-配置redis"><a href="#3-1-2-配置redis" class="headerlink" title="3.1.2. 配置redis"></a>3.1.2. 配置redis</h3><p>安装完毕后，需要先做一些设定工作，以便服务启动后能正常运行。使用文本编辑器，这里使用Notepad++，打开Redis服务配置文件。<strong>注意：不要找错了，通常为redis.windows-service.conf，而不是redis.windows.conf</strong>。后者是以非系统服务方式启动程序使用的配置文件。</p><p><img src="/2021/01/07/miaosha/redisproperties1.png" alt="redisproperties1.png"></p><p>找到含有requirepass字样的地方，追加一行，输入requirepass leyou。这是访问Redis时所需的密码，后面在项目中也需要设置。</p><p><img src="/2021/01/07/miaosha/redisproperties2.png" alt="redisproperties2.png"></p><p>测试一下Redis是否正常提供服务。进入Redis的目录，cd C:\Program Files\Redis。输入redis-cli并回车。（redis-cli是客户端程序）如图正常提示进入，并显示正确端口号，则表示服务已经启动。</p><p><img src="/2021/01/07/miaosha/redisproperties3.png" alt="redisproperties3.png"></p><p>输入 auth leyou，显示OK，则密码正确。</p><p><img src="/2021/01/07/miaosha/redisproperties4.png" alt="redisproperties4.png"></p><p>实际测试一下读写。输入set mykey “abd”并回车，用来保存一个键值。再输入get mykey，获取刚才保存的键值。</p><p><img src="/2021/01/07/miaosha/redisproperties5.png" alt="redisproperties5.png"></p><p>开启持久化，appendonly yes –默认为no。</p><p>持久化：将数据（如内存中的对象）保存到可永久保存的存储设备中。持久化的主要应用是将内存中的对象存储在数据库中，或者存储在磁盘文件中、 XML 数据文件中等等。</p><p>redis的数据都是缓存在内存中，当你重启系统或者关闭系统后，缓存在内存中的数据都会全部消失，再也找不回来了。所以为了让数据能够长期保存，就要将 Redis 放在缓存中的数据做持久化存储。</p><p><img src="/2021/01/07/miaosha/redisproperties6.png" alt="redisproperties6.png"></p><p>写入时机默认为everysec，每秒</p><p>也可以设置为always，实时写入，但是会有效率问题。</p><p><img src="/2021/01/07/miaosha/redisproperties7.png" alt="redisproperties7.png"></p><p>900秒有一个值存入，就持久化一次</p><p>300秒有10个值存入，就持久化一次</p><p>60秒有10000个值存入，就持久化一次</p><h2 id="3-2-安装RabbitMQ及配置"><a href="#3-2-安装RabbitMQ及配置" class="headerlink" title="3.2. 安装RabbitMQ及配置"></a>3.2. 安装RabbitMQ及配置</h2><h3 id="3-2-1-安装RabbitMQ客户端"><a href="#3-2-1-安装RabbitMQ客户端" class="headerlink" title="3.2.1. 安装RabbitMQ客户端"></a>3.2.1. 安装RabbitMQ客户端</h3><p>安装 otp_win64_20.2.exe</p><p><img src="/2021/01/07/miaosha/rabbitinstall1.png" alt="rabbitinstall1.png"></p><p><img src="/2021/01/07/miaosha/rabbitinstall2.png" alt="rabbitinstall2.png"></p><p><img src="/2021/01/07/miaosha/rabbitinstall3.png" alt="rabbitinstall3.png"></p><p><img src="/2021/01/07/miaosha/rabbitinstall4.png" alt="rabbitinstall4.png"></p><h3 id="3-2-2-安装RabbitMQ服务端"><a href="#3-2-2-安装RabbitMQ服务端" class="headerlink" title="3.2.2. 安装RabbitMQ服务端"></a>3.2.2. 安装RabbitMQ服务端</h3><p>安装 rabbitmq-server-3.7.4.exe</p><p><img src="/2021/01/07/miaosha/rabbitinstall5.png" alt="rabbitinstall5.png"></p><p><img src="/2021/01/07/miaosha/rabbitinstall6.png" alt="rabbitinstall6.png"></p><p><img src="/2021/01/07/miaosha/rabbitinstall7.png" alt="rabbitinstall7.png"></p><h3 id="3-2-3-配置RabbitMQ服务端"><a href="#3-2-3-配置RabbitMQ服务端" class="headerlink" title="3.2.3. 配置RabbitMQ服务端"></a>3.2.3. 配置RabbitMQ服务端</h3><p><img src="/2021/01/07/miaosha/RabbitMQ-path.png" alt="RabbitMQ-path.png"></p><p>配置RabbitMQ客户端环境变量</p><p><img src="/2021/01/07/miaosha/RabbitMQ-path2.png" alt="RabbitMQ-path2.png"></p><p>配置RabbitMQ服务端环境变量</p><p><img src="/2021/01/07/miaosha/RabbitMQ-path3.png" alt="RabbitMQ-path3.png"></p><p>在环境变量中增加RabbitMQ服务端</p><p><img src="/2021/01/07/miaosha/RabbitMQ-path4.png" alt="RabbitMQ-path4.png"></p><p>安装插件：rabbitmq-plugins.bat enable rabbitmq_management</p><p>重启RabbitMQ服务</p><p>启动RabbitMQ</p><p><img src="/2021/01/07/miaosha/RabbitMQ-path5.png" alt="RabbitMQ-path5.png"></p><h1 id="四、秒杀系统创建"><a href="#四、秒杀系统创建" class="headerlink" title="四、秒杀系统创建"></a>四、秒杀系统创建</h1><p>首先看一下秒杀的目录结构</p><p><img src="/2021/01/07/miaosha/%E7%9B%AE%E5%BD%95.png" alt="目录.png"></p><h2 id="4-1-创建Eureka注册中心（端口号9000）"><a href="#4-1-创建Eureka注册中心（端口号9000）" class="headerlink" title="4.1. 创建Eureka注册中心（端口号9000）"></a>4.1. 创建Eureka注册中心（端口号9000）</h2><hr><p>第一步：选择File-New-Module…，弹出的窗口中选择Spring initializr，选择Module SDK，选择Next</p><p><img src="/2021/01/07/miaosha/EurekaServer.png" alt="EurekaServer.png"></p><p>第二步：Group为com.itheima，Artifact为leyou，Name为leyouServer，Description为Server For leyou Project，选择Next</p><p><img src="/2021/01/07/miaosha/EurekaServer2.png" alt="EurekaServer2.png"></p><p>第三步：选择 Spring Cloud Discovery，选择 Eureka Server，选择Next</p><p><img src="/2021/01/07/miaosha/assets%5CEurekaServer3.png" alt="EurekaServer3.png"></p><p>第四步：Module name 为 leyouServer，Content root为路径+leyouServer，选择Finish，此时在项目文件夹下会创建一个 leyouServer文件夹</p><p><img src="/2021/01/07/miaosha/EurekaServer4.png" alt="EurekaServer4.png"></p><h3 id="4-1-1-配置pom-xml"><a href="#4-1-1-配置pom-xml" class="headerlink" title="4.1.1. 配置pom.xml"></a>4.1.1. 配置pom.xml</h3><p>在生成的项目中，打开pom.xml，配置依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/01/07/miaosha/Mavenimport.png" alt="Mavenimport.png"></p><p>在右下角悬浮的窗口中点击 Import Changes，会自动到Maven远程仓库去下载所需要用到的jar包。</p><p>如果没有引入，可以根据下图，在IDEA右侧选择 Maven Projects，找到leyouServer选择 Dependencies右击，选择 Download Sources，也会去Maven远程仓库下载所需要用到的jar包，后面的所有项目都如此。</p><p><img src="/2021/01/07/miaosha/MavenImport1.png" alt="MavenImport1.png"></p><h3 id="4-1-2-配置文件application-properties"><a href="#4-1-2-配置文件application-properties" class="headerlink" title="4.1.2. 配置文件application.properties"></a>4.1.2. 配置文件application.properties</h3><p>在生成的项目中，打开src\man\resources\application.properties，配置端口号等</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">9000</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br><span class="line"><span class="meta">eureka.instance.hostname</span>=<span class="string">localhost</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-server</span></span><br><span class="line"><span class="comment">#不从服务器拿服务信息</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">false</span></span><br><span class="line"><span class="comment">#不在服务端注册</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure><p><strong>注意：这里的端口号后一定不能加入空格等字符，否则会报错</strong></p><p><img src="/2021/01/07/miaosha/error.png" alt="error.png"></p><h3 id="4-1-3-编写启动类"><a href="#4-1-3-编写启动类" class="headerlink" title="4.1.3. 编写启动类"></a>4.1.3. 编写启动类</h3><p>在生成的项目中，打开src\main\java\com.itheima.leyou\leyouServerApplication，在已经生成的启动类中加入 @EnableEurekaServer，意思为启动Eureka服务端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(ServerApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试运行注册中心，在浏览器中输入 <a target="_blank" rel="noopener" href="http://localhost:9000/">http://localhost:9000</a></p><p><img src="/2021/01/07/miaosha/EurekaServer5.png" alt="EurekaServer5.png"></p><p>到这里，注册中心服务完成。</p><h2 id="4-2-创建时间服务（端口号8000）"><a href="#4-2-创建时间服务（端口号8000）" class="headerlink" title="4.2. 创建时间服务（端口号8000）"></a>4.2. 创建时间服务（端口号8000）</h2><hr><h3 id="4-2-1-创建时间服务"><a href="#4-2-1-创建时间服务" class="headerlink" title="4.2.1. 创建时间服务"></a>4.2.1. 创建时间服务</h3><p>第一步：选择File-New-Module…，弹出的窗口中选择Spring initializr，选择Module SDK，选择Next</p><p>第二步：Group为com.itheima，Artifact为leyou，Name为leyouTimeServer，Description为TimeServer For leyou Project，选择Next</p><p>第三步：选择 Spring Cloud Discovery，选择 Eureka Discovery Client，选择Next</p><p>第四步：Module name 为 leyouTimeServer，Content root为路径+leyouTimeServer，选择Finish，此时在项目文件夹下会创建一个 leyouTimeServer文件夹</p><p>在生成的项目中，打开pom.xml，配置依赖，其中spring-cloud-starter-netflix-eureka-client为项目引入了Eureka客户端的jar包，spring-boot-starter-web引入了web场景下，web模块开发所用到的jar包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>leyouTimeServer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/01/07/miaosha/MavenImport.png" alt="MavenImport.png"></p><p>在生成的项目中，打开src\man\resources\application.properties，配置端口号等</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8000</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-time-server</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在生成的项目中，打开src\main\java\com.itheima.leyou\leyouTimeServerApplication，在已经生成的启动类中加入 @EnableEurekaClient，意思为启动Eureka客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(TimeServerApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>测试运行订单服务，在Eureka注册中心中可以看到 leyou-time-server服务，证明服务启动成功</p><h3 id="4-2-2-创建controller文件夹，并创建timeController-java文件"><a href="#4-2-2-创建controller文件夹，并创建timeController-java文件" class="headerlink" title="4.2.2. 创建controller文件夹，并创建timeController.java文件"></a>4.2.2. 创建controller文件夹，并创建timeController.java文件</h3><p>给TimeController.java类增加注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">timeController</span> </span>&#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-2-3-创建时间查询方法（getTime）"><a href="#4-2-3-创建时间查询方法（getTime）" class="headerlink" title="4.2.3. 创建时间查询方法（getTime）"></a>4.2.3. 创建时间查询方法（getTime）</h3><p>用途：给前端秒杀提供统一的时间标准，在TimeController里写入如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/getTime&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getTime</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> simpleDateFormat.format(<span class="keyword">new</span> Date());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-4-测试时间查询"><a href="#4-2-4-测试时间查询" class="headerlink" title="4.2.4. 测试时间查询"></a>4.2.4. 测试时间查询</h3><p>直接通过页面访问 getTime 方法，然后得到当前时间，地址：<a target="_blank" rel="noopener" href="http://localhost:8000/getTime">http://localhost:8000/getTime</a></p><p><img src="/2021/01/07/miaosha/getTime.png" alt="getTime.png"></p><h2 id="4-3-创建商品服务（端口号7000）"><a href="#4-3-创建商品服务（端口号7000）" class="headerlink" title="4.3. 创建商品服务（端口号7000）"></a>4.3. 创建商品服务（端口号7000）</h2><hr><h3 id="4-3-1-创建商品表结构（略）"><a href="#4-3-1-创建商品表结构（略）" class="headerlink" title="4.3.1. 创建商品表结构（略）"></a>4.3.1. 创建商品表结构（略）</h3><h3 id="4-3-2-创建商品服务"><a href="#4-3-2-创建商品服务" class="headerlink" title="4.3.2. 创建商品服务"></a>4.3.2. 创建商品服务</h3><p>第一步：选择File-New-Module…，弹出的窗口中选择Spring initializr，选择Module SDK，选择Next</p><p><img src="/2021/01/07/miaosha/leyouStock1.png" alt="leyouStock1.png"></p><p>第二步：Group为com.itheima，Artifact为leyou，Name为leyouStock，Description为Stock For leyou Project，选择Next</p><p><img src="/2021/01/07/miaosha/leyouStock2.png" alt="leyouStock2.png"></p><p>第三步：选择 Spring Cloud Discovery，选择 Eureka Discovery Client，选择Next</p><p><img src="/2021/01/07/miaosha/leyouStock3.png" alt="leyouStock3.png"></p><p>第四步：Module name 为 leyouStock，Content root为路径+leyouStock，选择Finish，此时在项目文件夹下会创建一个 leyouStock文件夹</p><p><img src="/2021/01/07/miaosha/leyouStock4.png" alt="leyouStock4.png"></p><h3 id="4-3-3-配置pom-xml"><a href="#4-3-3-配置pom-xml" class="headerlink" title="4.3.3. 配置pom.xml"></a>4.3.3. 配置pom.xml</h3><p>在生成的项目中，打开pom.xml，配置依赖，其中spring-cloud-starter-netflix-eureka-client为项目引入了Eureka客户端的jar包，spring-boot-starter-web引入了web场景下，web模块开发所用到的jar包（<strong>每个客户端必须要有这个依赖</strong>），利用alibaba的fastjson解析json数据，所以引入alibaba.fastjson用到的jar包，mysql-connector-java与spring-boot-starter-data-jpa依赖引入mysql连接使用的jar包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>leyouStock<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.41<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/01/07/miaosha/MavenImport.png" alt="MavenImport.png"></p><h3 id="4-3-4-配置文件application-properties"><a href="#4-3-4-配置文件application-properties" class="headerlink" title="4.3.4. 配置文件application.properties"></a>4.3.4. 配置文件application.properties</h3><p>在生成的项目中，打开src\man\resources\application.properties，配置端口号等</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">7000</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-stock</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/code1_2?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#redis数据库编号，存在0~15共16个数据库</span></span><br><span class="line"><span class="meta">spring.redis.database</span>=<span class="string">0</span></span><br><span class="line"><span class="comment">#redis服务器IP</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment">#redis端口号</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="comment">#redis密码</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string">leyou</span></span><br><span class="line"><span class="comment">#redis请求超时时间，超过此值redis自动断开连接</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">10000ms</span></span><br><span class="line"><span class="comment">#jedis最大连接数，超过此值则提示获取不到连接异常</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-active</span>=<span class="string">32</span></span><br><span class="line"><span class="comment">#jedis最大等待时间，超过此值会提示连接超时异常</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-wait</span>=<span class="string">10000ms</span></span><br><span class="line"><span class="comment">#jedis最大等待连接数</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-idle</span>=<span class="string">32</span></span><br><span class="line"><span class="comment">#jedis最小等待连接数</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure><h3 id="4-3-5-编写启动类"><a href="#4-3-5-编写启动类" class="headerlink" title="4.3.5. 编写启动类"></a>4.3.5. 编写启动类</h3><p>在生成的项目中，打开src\main\java\com.itheima.leyou\leyouStockApplication，在已经生成的启动类中加入 @EnableEurekaClient，意思为启动Eureka客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(StockApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：这里如果 @EnableEurekaClient报错，那就证明依赖文件引入有误，比如：在依赖spring-cloud-starter-netflix-eureka-client后加个1，如下图：</p><p><img src="/2021/01/07/miaosha/leyoustockerror1.png" alt="leyouStockerror1.png"></p><p>会导致：</p><p><img src="/2021/01/07/miaosha/leyoustockerror2.png" alt="leyoustockerror2.png"></p><p><strong>注意：一般会犯错的地方是 starter 写成 start，不容易看出来，可以到maven projects里去查看是否有错误</strong></p><p>测试运行商品服务，在Eureka注册中心中可以看到 leyou-Stock服务，证明服务启动成功</p><p><img src="/2021/01/07/miaosha/leyouStock5.png" alt="leyouStock5.png"></p><h3 id="4-3-6-创建controller-service-dao文件夹，并创建StockController-java-StockService-java-StockDao-java文件"><a href="#4-3-6-创建controller-service-dao文件夹，并创建StockController-java-StockService-java-StockDao-java文件" class="headerlink" title="4.3.6. 创建controller\service\dao文件夹，并创建StockController.java\StockService.java\StockDao.java文件"></a>4.3.6. 创建controller\service\dao文件夹，并创建StockController.java\StockService.java\StockDao.java文件</h3><p>Controller：管理业务（Service）调度和管理跳转</p><p>Service：管理具体功能、分支判断</p><p>Dao：管理数据交互，完成增删改查</p><p>Controller像是服务员，顾客点什么菜，在几号桌。</p><p>Service像是厨师，前端请求过来的菜单上的菜都是他做。</p><p>Dao像是厨房小工，原材料都是他来打交道。</p><p><img src="/2021/01/07/miaosha/SSH%E6%B5%81%E7%A8%8B.png" alt="SSH流程.png"></p><h3 id="4-3-7-创建商品列表查询方法（getStockList）"><a href="#4-3-7-创建商品列表查询方法（getStockList）" class="headerlink" title="4.3.7. 创建商品列表查询方法（getStockList）"></a>4.3.7. 创建商品列表查询方法（getStockList）</h3><p>用途：为前端页面服务提供商品列表数据，主要用于前端商品列表页展示。</p><p>先约定好和前端交互返回的数据结构：</p><p>返回的json字符串：</p><p>如果返回值错误：{“result”:”false”, “msg”:”****”}</p><p>如果返回值正确：{“result”:”true”, “msg”:””, “sku_list”:[“id”:1,”sku_id”:…]}</p><p>先从Dao的方法开始编写代码：</p><p>创建Dao层接口文件，IStockDao</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IStockDao</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>给StockDao.java类增加注解，@Repository用于标注数据访问组件，即DAO组件，实现IStockDao接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockDao</span> <span class="keyword">implements</span> <span class="title">IStockDao</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>声明 JDBCTemplate 方法，用于连接数据库使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br></pre></td></tr></table></figure><p>增加getStockList方法，首先从数据库中将商品列表所需要的数据查询出来，装入一个ArrayList变量中，原因是商品列表有多行数据，是一个列表，然后将ArrayList返回，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1、创建一个SQL</span></span><br><span class="line">String sql = <span class="string">&quot;select id AS sku_id, title, images, stock, price, indexes, own_spec &quot;</span> +</span><br><span class="line">        <span class="string">&quot;from tb_sku&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2、执行这个SQL</span></span><br><span class="line">ArrayList&lt;Map&lt;String, Object&gt;&gt; list = (ArrayList&lt;Map&lt;String, Object&gt;&gt;) jdbcTemplate.queryForList(sql);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3、返回数据</span></span><br><span class="line"><span class="keyword">return</span> list;</span><br></pre></td></tr></table></figure><p>再编写Service</p><p>创建Service层接口文件，IStockService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IStockService</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>给StockService.java增加注解，并实现IStockService接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockService</span> <span class="keyword">implements</span> <span class="title">IStockService</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>加入IStockDao接口的引用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IStockDao iStockDao;</span><br></pre></td></tr></table></figure><p>增加getStockList方法，调用StockDao中的getStockList，返回一个Map</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getStockList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        <span class="comment">//1、取IstockDao的方法</span></span><br><span class="line">        ArrayList&lt;Map&lt;String, Object&gt;&gt; list = iStockDao.getStockList();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、如果没取出数据，返回错误信息</span></span><br><span class="line">        <span class="keyword">if</span> (list==<span class="keyword">null</span>||list.size()==<span class="number">0</span>)&#123;</span><br><span class="line">            resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;我们也不知道为啥没取出数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> resultMap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、从redis里取数据</span></span><br><span class="line">        resultMap = getLimitPolicy(list);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、返回正常信息</span></span><br><span class="line">        resultMap.put(<span class="string">&quot;sku_list&quot;</span>, list);</span><br><span class="line"><span class="comment">//        resultMap.put(&quot;result&quot;, true);</span></span><br><span class="line"><span class="comment">////        resultMap.put(&quot;msg&quot;, &quot;&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>注意：这里的Service有业务逻辑判断，当Dao返回数据后，如果数据为空，需要加入业务逻辑判断，未找到相应的商品信息，如果不加该判断，前端页面获取的数据为空，那么页面上会空白并且不显示任何数据，会给页面操作者带来不好的体验感，疑惑：是不是网络中断？或者服务器宕机？所以这里返回“未找到相应的商品信息”的提示，有助于页面友好的显示。前端的程序员也可以通过result参数判断</strong></p><p>通过alt+回车，选择Create method ‘getStockList’，在IStockDao接口文件中自动创建接口的方法。</p><p><img src="/2021/01/07/miaosha/IStockService.png" alt="IStockService.png"></p><p>在IStockDao接口文件中给方法加上public修饰符，</p><p><img src="/2021/01/07/miaosha/IStockService1.png" alt="IStockService1.png"></p><p>给StockController.java类增加注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockController</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>加入IStockService接口的引用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IStockService iStockService;</span><br></pre></td></tr></table></figure><p>增加 getStockList 方法，调用StockService中的getStockList，返回的是一个Map，对于页面来说是得到一个Json字符串</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/getStockList&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getStockList</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> iStockService.getStockList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试getStockList方法，在浏览器中输入 <a target="_blank" rel="noopener" href="http://localhost:7000/getStockList">http://localhost:7000/getStockList</a></p><p><img src="/2021/01/07/miaosha/getStockList.png" alt="getStockList"></p><h3 id="4-3-8-创建商品查询方法（getStock）"><a href="#4-3-8-创建商品查询方法（getStock）" class="headerlink" title="4.3.8. 创建商品查询方法（getStock）"></a>4.3.8. 创建商品查询方法（getStock）</h3><p>用途：为前端页面服务提供商品详情页数据，主要用于前端商品详情页展示。</p><p>在StockDao.java类中增加 getStock方法，带一个sku_id参数，意思是通过sku_id进行查找，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1、创建一个SQL</span></span><br><span class="line">String sql = <span class="string">&quot;select tb_sku.spu_id, tb_sku.title, tb_sku.images, tb_sku.stock, tb_sku.price, tb_sku.indexes, &quot;</span> +</span><br><span class="line">        <span class="string">&quot;tb_sku.own_spec, tb_sku.enable, tb_sku.create_time, tb_sku.update_time,tb_spu_detail.description,&quot;</span> +</span><br><span class="line">        <span class="string">&quot;tb_sku.id AS sku_id,tb_spu_detail.special_spec &quot;</span> +</span><br><span class="line">        <span class="string">&quot;from tb_sku &quot;</span> +</span><br><span class="line">        <span class="string">&quot;INNER JOIN tb_spu_detail ON tb_spu_detail.spu_id=tb_sku.spu_id &quot;</span> +</span><br><span class="line">        <span class="string">&quot;where tb_sku.id = ?&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2、执行这个SQL</span></span><br><span class="line">ArrayList&lt;Map&lt;String, Object&gt;&gt; list = (ArrayList&lt;Map&lt;String, Object&gt;&gt;) jdbcTemplate.queryForList(sql, sku_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3、返回数据</span></span><br><span class="line"><span class="keyword">return</span> list;</span><br></pre></td></tr></table></figure><p>在StockService.java类中增加getStock方法，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getStock</span><span class="params">(String sku_id)</span></span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、传入参数</span></span><br><span class="line">        <span class="keyword">if</span> (sku_id==<span class="keyword">null</span>||sku_id.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">            resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;前端传过来的什么东东？&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> resultMap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、取IstockDao的方法</span></span><br><span class="line">        ArrayList&lt;Map&lt;String, Object&gt;&gt; list = iStockDao.getStock(sku_id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、如果没取出数据，返回错误信息</span></span><br><span class="line">        <span class="keyword">if</span> (list==<span class="keyword">null</span>||list.size()==<span class="number">0</span>)&#123;</span><br><span class="line">            resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;数据库咋回事，还取不出来数据了！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> resultMap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、从redis里取数据</span></span><br><span class="line">        resultMap = getLimitPolicy(list);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、返回正常信息</span></span><br><span class="line">        resultMap.put(<span class="string">&quot;sku&quot;</span>, list);</span><br><span class="line"><span class="comment">//        resultMap.put(&quot;result&quot;, true);</span></span><br><span class="line"><span class="comment">//        resultMap.put(&quot;msg&quot;, &quot;&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>注意：这里的Service有业务逻辑判断，如果传入参数为空时，会导致数据库查询报错，因此在传入Dao层之前进行判断，传入的参数是否合法。当Dao返回数据后，如果数据为空，也需要加入业务逻辑判断，未找到相应的商品信息</strong></p><p>同时，在IStockDao中生成相对应的方法。</p><p>在StockController.java类中增加getStock方法，需要增加注解@RequestMapping，其中value = “/getStock/{sku_id}，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/getStock/&#123;sku_id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getStock</span><span class="params">(<span class="meta">@PathVariable(&quot;sku_id&quot;)</span> String sku_id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> iStockService.getStock(sku_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试getStock方法，在浏览器中输入localhost:7000/getStock/123</p><p><img src="/2021/01/07/miaosha/getStockBySKU1.png" alt="getStockBySKU1.png"></p><p>在浏览器中输入localhost:7000/getStock/26816294479</p><p><img src="/2021/01/07/miaosha/getStockBySKU2.png" alt="getStockBySKU2.png"></p><p>从redis里取值方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title">getLimitPolicy</span><span class="params">(ArrayList&lt;Map&lt;String, Object&gt;&gt; list)</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map&lt;String, Object&gt; skuMap: list)&#123;</span><br><span class="line">        <span class="comment">//3.1、从redis取出政策</span></span><br><span class="line">        String policy = stringRedisTemplate.opsForValue().get(<span class="string">&quot;LIMIT_POLICY_&quot;</span>+skuMap.get(<span class="string">&quot;sku_id&quot;</span>).toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.2、判断有政策的才继续</span></span><br><span class="line">        <span class="keyword">if</span> (policy!=<span class="keyword">null</span>&amp;&amp;!policy.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">            Map&lt;String, Object&gt; policyInfo = JSONObject.parseObject(policy, Map.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3.3、开始时间小于等于当前时间，并且当前时间小于等于结束时间</span></span><br><span class="line">            SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>);</span><br><span class="line">            String now = restTemplate.getForObject(<span class="string">&quot;http://leyou-time-server/getTime&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Date end_time = simpleDateFormat.parse(policyInfo.get(<span class="string">&quot;end_time&quot;</span>).toString());</span><br><span class="line">                Date begin_time = simpleDateFormat.parse(policyInfo.get(<span class="string">&quot;begin_time&quot;</span>).toString());</span><br><span class="line">                Date now_time = simpleDateFormat.parse(now);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (begin_time.getTime()&lt;=now_time.getTime()&amp;&amp;now_time.getTime()&lt;=end_time.getTime())&#123;</span><br><span class="line">                    skuMap.put(<span class="string">&quot;limitPrice&quot;</span>, policyInfo.get(<span class="string">&quot;price&quot;</span>));</span><br><span class="line">                    skuMap.put(<span class="string">&quot;limitQuanty&quot;</span>, policyInfo.get(<span class="string">&quot;quanty&quot;</span>));</span><br><span class="line">                    skuMap.put(<span class="string">&quot;limitBeginTime&quot;</span>, policyInfo.get(<span class="string">&quot;begin_time&quot;</span>));</span><br><span class="line">                    skuMap.put(<span class="string">&quot;limitEndTime&quot;</span>, policyInfo.get(<span class="string">&quot;end_time&quot;</span>));</span><br><span class="line">                    skuMap.put(<span class="string">&quot;nowTime&quot;</span>, now);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-9-秒杀政策表结构"><a href="#4-3-9-秒杀政策表结构" class="headerlink" title="4.3.9. 秒杀政策表结构"></a>4.3.9. 秒杀政策表结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `tb_limit_policy`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_limit_policy` (</span><br><span class="line">  `id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `sku_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;skuid&#x27;</span>,</span><br><span class="line">  `quanty` <span class="type">BIGINT</span>(<span class="number">20</span>) COMMENT <span class="string">&#x27;数量&#x27;</span>,</span><br><span class="line">  `price` <span class="type">BIGINT</span>(<span class="number">20</span>) COMMENT <span class="string">&#x27;秒杀价格&#x27;</span>,</span><br><span class="line">  `begin_time` <span class="type">TIMESTAMP</span> COMMENT <span class="string">&#x27;开始时间&#x27;</span>,</span><br><span class="line">  `end_time` <span class="type">TIMESTAMP</span> COMMENT <span class="string">&#x27;结束时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><h3 id="4-3-10-创建秒杀政策增加方法（insertLimitPolicy）"><a href="#4-3-10-创建秒杀政策增加方法（insertLimitPolicy）" class="headerlink" title="4.3.10. 创建秒杀政策增加方法（insertLimitPolicy）"></a>4.3.10. 创建秒杀政策增加方法（insertLimitPolicy）</h3><p>用途：用于创建秒杀政策，并将政策写入 Redis 缓存。</p><p>在StockDao.java中增加一个insertLimitPolicy方法，带一个map参数，map里是前端页面传入的信息，返回一个boolean值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">insertLimitPolicy</span><span class="params">(Map&lt;String, Object&gt; map)</span></span>&#123;</span><br><span class="line">    String sql = <span class="string">&quot;insert into tb_limit_policy (sku_id, quanty, price, begin_time, end_time) &quot;</span> +</span><br><span class="line">            <span class="string">&quot;Values (?, ?, ?, ?, ?)&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.update(sql, map.get(<span class="string">&quot;sku_id&quot;</span>), map.get(<span class="string">&quot;quanty&quot;</span>), map.get(<span class="string">&quot;price&quot;</span>), map.get(<span class="string">&quot;begin_time&quot;</span>), map.get(<span class="string">&quot;end_time&quot;</span>))==<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在StockService.java里增加一个insertLimitPolicy方法，返回一个map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">insertLimitPolicy</span><span class="params">(Map&lt;String, Object&gt; policyMap)</span></span>&#123;</span><br><span class="line">        <span class="comment">//1、判断传入的参数是不是合法</span></span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        <span class="keyword">if</span> (policyMap==<span class="keyword">null</span>||policyMap.isEmpty())&#123;</span><br><span class="line">            resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;传入什么东东&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> resultMap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、从StockDao接口中调用insertLimitPolicy方法</span></span><br><span class="line">        <span class="keyword">boolean</span> result = iStockDao.insertLimitPolicy(policyMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、判断执行成功或失败，如果失败，返回错误信息</span></span><br><span class="line">        <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">            resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;数据执行咋又失败了&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> resultMap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、如果成功，写入redis，需要写入有效期，key取名：LIMIT_POLICY_&#123;sku_id&#125;</span></span><br><span class="line">        <span class="keyword">long</span> diff = <span class="number">0</span>;</span><br><span class="line">        String now = restTemplate.getForObject(<span class="string">&quot;http://leyou-time-server/getTime&quot;</span>, String.class);</span><br><span class="line"></span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>);</span><br><span class="line">        <span class="comment">//结束日期减去当前日期得到政策的有效期</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Date end_time = simpleDateFormat.parse(policyMap.get(<span class="string">&quot;end_time&quot;</span>).toString());</span><br><span class="line">            Date now_time = simpleDateFormat.parse(now);</span><br><span class="line">            diff = (end_time.getTime() - now_time.getTime())/<span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (diff&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">                resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;结束时间不能小于当前时间&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> resultMap;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;日期转换又失败了&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> resultMap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String policy = JSON.toJSONString(policyMap);</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;LIMIT_POLICY_&quot;</span>+policyMap.get(<span class="string">&quot;sku_id&quot;</span>).toString(), policy, diff, TimeUnit.SECONDS);</span><br><span class="line">        ArrayList&lt;Map&lt;String, Object&gt;&gt; list = iStockDao.getStock(policyMap.get(<span class="string">&quot;sku_id&quot;</span>).toString());</span><br><span class="line">        String sku = JSON.toJSONString(list.get(<span class="number">0</span>));</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;SKU_&quot;</span>+policyMap.get(<span class="string">&quot;sku_id&quot;</span>).toString(), sku, diff, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5、返回正常信息</span></span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>注意：这里的Service有业务逻辑判断，首先判断传入的json是否可以转化成功，其次是写入数据库成功或者失败。</strong></p><p><strong>这里加入了一个@Transactional，是需要开启事务，需要记住只要是insert\delete\update这三个语句都需要开启事务，一旦写入数据库失败，可以回滚，由于上面涉及到的方法都是查询，所以不用开启事务</strong></p><p>在StockController里增加一个insertLimitPolicy方法，需要增加注解@RequestMapping，其中value = “/insertLimitPolicy/{jsonObj}，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/insertLimitPolicy/&#123;jsonObj&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">insertLimitPolicy</span><span class="params">(<span class="meta">@PathVariable(&quot;jsonObj&quot;)</span> String jsonObj)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> iStockService.insertLimitPolicy(jsonObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试insertLimitPolicy方法，在浏览器中输入<a target="_blank" rel="noopener" href="http://localhost:7000/insertLimitPolicy/%7Bsku_id:'26816294479',quanty:1000,price:1000,begin_time:'2019-08-05%2011:00',end_time:'2019-10-05%2012:00'%7D">http://localhost:7000/insertLimitPolicy/{sku_id:’26816294479’,quanty:1000,price:1000,begin_time:’2019-08-05 11:00’,end_time:’2019-10-05 12:00’}</a></p><p><img src="/2021/01/07/miaosha/limitpolicy.png" alt="limitpolicy.png"></p><h3 id="4-3-11-在新增政策的时候存入redis"><a href="#4-3-11-在新增政策的时候存入redis" class="headerlink" title="4.3.11. 在新增政策的时候存入redis"></a>4.3.11. 在新增政策的时候存入redis</h3><p>步骤：</p><p>1、配置redis依赖</p><p>2、配置文件application.properties增加redis配置</p><p>3、编写启动类增加restTemplate，需要调用时间服务</p><p>4、在Service时增加 RestTemplate 和 StringRedisTemplate 的变量声明</p><p>4、写入政策数据库表。</p><p>5、将政策写入Redis，key为 LIMIT_POLICY_{sku_id}。</p><p>6、结束时间到了，利用Redis的删除机制，自动删除，以减少内存占用。时间通过政策结束时间减去当前时间得到。</p><p>代码如下：</p><p>声明StringRestTemplate</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">StringRedisTemplate stringRedisTemplate;</span><br></pre></td></tr></table></figure><p>修改StockService里的insertLimitPolicy方法，增加以下代码</p><p><img src="/2021/01/07/miaosha/insertLimitpolicy.png" alt="insertlimitpolicy.png"></p><h3 id="4-3-12-封装商品列表和商品详情时取redis政策的方法（getLimitPolicy）"><a href="#4-3-12-封装商品列表和商品详情时取redis政策的方法（getLimitPolicy）" class="headerlink" title="4.3.12. 封装商品列表和商品详情时取redis政策的方法（getLimitPolicy）"></a>4.3.12. 封装商品列表和商品详情时取redis政策的方法（getLimitPolicy）</h3><p>步骤：</p><p>1、循环商品列表</p><p>2、取出每个sku_id的政策</p><p>3、赋值给商品列表中</p><p>封装方法：getLimitPolicy</p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title">getLimitPolicy</span><span class="params">(ArrayList&lt;Map&lt;String, Object&gt;&gt; list)</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map&lt;String, Object&gt; skuMap: list)&#123;</span><br><span class="line">        <span class="comment">//3.1、从redis取出政策</span></span><br><span class="line">        String policy = stringRedisTemplate.opsForValue().get(<span class="string">&quot;LIMIT_POLICY_&quot;</span>+skuMap.get(<span class="string">&quot;sku_id&quot;</span>).toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.2、判断有政策的才继续</span></span><br><span class="line">        <span class="keyword">if</span> (policy!=<span class="keyword">null</span>&amp;&amp;!policy.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">            Map&lt;String, Object&gt; policyInfo = JSONObject.parseObject(policy, Map.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3.3、开始时间小于等于当前时间，并且当前时间小于等于结束时间</span></span><br><span class="line">            SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>);</span><br><span class="line">            String now = restTemplate.getForObject(<span class="string">&quot;http://leyou-time-server/getTime&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Date end_time = simpleDateFormat.parse(policyInfo.get(<span class="string">&quot;end_time&quot;</span>).toString());</span><br><span class="line">                Date begin_time = simpleDateFormat.parse(policyInfo.get(<span class="string">&quot;begin_time&quot;</span>).toString());</span><br><span class="line">                Date now_time = simpleDateFormat.parse(now);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (begin_time.getTime()&lt;=now_time.getTime()&amp;&amp;now_time.getTime()&lt;=end_time.getTime())&#123;</span><br><span class="line">                    skuMap.put(<span class="string">&quot;limitPrice&quot;</span>, policyInfo.get(<span class="string">&quot;price&quot;</span>));</span><br><span class="line">                    skuMap.put(<span class="string">&quot;limitQuanty&quot;</span>, policyInfo.get(<span class="string">&quot;quanty&quot;</span>));</span><br><span class="line">                    skuMap.put(<span class="string">&quot;limitBeginTime&quot;</span>, policyInfo.get(<span class="string">&quot;begin_time&quot;</span>));</span><br><span class="line">                    skuMap.put(<span class="string">&quot;limitEndTime&quot;</span>, policyInfo.get(<span class="string">&quot;end_time&quot;</span>));</span><br><span class="line">                    skuMap.put(<span class="string">&quot;nowTime&quot;</span>, now);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里要注意：将政策写入列表里传给前端页面</p><p>limitPrice：政策上的价格</p><p>limitBeginTime：政策上开始时间</p><p>limitEndTime：政策上结束时间</p><p>nowTime：当前时间</p><h2 id="4-4-创建库存服务（端口号6001）"><a href="#4-4-创建库存服务（端口号6001）" class="headerlink" title="4.4. 创建库存服务（端口号6001）"></a>4.4. 创建库存服务（端口号6001）</h2><hr><p><strong>注意：这里配置端口号不是6000，而是6001，原因是Chrome谷歌浏览器6000端口是访问不了的</strong></p><h3 id="4-4-1-创建库存表结构"><a href="#4-4-1-创建库存表结构" class="headerlink" title="4.4.1. 创建库存表结构"></a>4.4.1. 创建库存表结构</h3><p>1、库房表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `tb_warehouse`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_warehouse` (</span><br><span class="line">  `id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;库房id&#x27;</span>,</span><br><span class="line">  `name` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;库房名称&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">TIMESTAMP</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">TIMESTAMP</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><p>2、库存主表</p><p>用途：用于存储库存余量</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `tb_stock_storage`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_stock_storage` (</span><br><span class="line">  `id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `warehouse_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;库房id&#x27;</span>,</span><br><span class="line">  `sku_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;skuid&#x27;</span>,</span><br><span class="line">  `quanty` <span class="type">DECIMAL</span>(<span class="number">18</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;剩余数量&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><p>3、库存历史表</p><p>用途：用于存储库存出入库明细历史</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `tb_stock_storage_history`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_stock_storage_history` (</span><br><span class="line">  `id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `stock_storage_id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;库存主表id&#x27;</span>,</span><br><span class="line">  `in_quanty` <span class="type">DECIMAL</span>(<span class="number">18</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;入库数量&#x27;</span>,</span><br><span class="line">  `out_quanty` <span class="type">DECIMAL</span>(<span class="number">18</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;出库数量&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><p>库存写入规则：</p><p><img src="/2021/01/07/miaosha/tb_stock_storage.png" alt="tb_stock_storage.png"></p><p><strong>注意：库存主表，一个库房一个商品只有一条记录，quanty存入的是剩余数量。</strong></p><p><strong>库存历史表，每一个库房的每一个商品对应一个库存主表ID，记录出入库的历史数量。</strong></p><p>写入规则说明：</p><p>1、通过sku_id判断库存主表是否有数据；</p><p>2、如果有数据，得到库存主表的id；</p><p>3、如果没有数据，则先写入库存主表，得到库存主表的id；</p><p>4、根据库存主表的id写入到历史表；</p><p>5、当库存主表有数据时，通过库存主表的id再次更新数量。</p><h3 id="4-4-2-创建库存服务"><a href="#4-4-2-创建库存服务" class="headerlink" title="4.4.2. 创建库存服务"></a>4.4.2. 创建库存服务</h3><p>第一步：选择File-New-Module…，弹出的窗口中选择Spring initializr，选择Module SDK，选择Next</p><p><img src="/2021/01/07/miaosha/EurekaServer.png" alt="EurekaServer.png"></p><p>第二步：Group为com.itheima，Artifact为leyou，Name为leyouStorage，Description为Storage For leyou Project，选择Next</p><p><img src="/2021/01/07/miaosha/eurekaStorage1.png" alt="eurekaStorage1.png"></p><p>第三步：选择 Spring Cloud Discovery，选择 Eureka Discovery Client，选择Next</p><p><img src="/2021/01/07/miaosha/leyouStock3.png" alt="leyouStock3.png"></p><p>第四步：Module name 为 leyouStorage，Content root为路径+leyouStorage，选择Finish，此时在项目文件夹下会创建一个 leyouStorage文件夹</p><p><img src="/2021/01/07/miaosha/eurekaStorage2.png" alt="eurekaStorage2.png"></p><h3 id="4-4-3-配置pom-xml"><a href="#4-4-3-配置pom-xml" class="headerlink" title="4.4.3. 配置pom.xml"></a>4.4.3. 配置pom.xml</h3><p>在生成的项目中，打开pom.xml，配置依赖，其中spring-cloud-starter-netflix-eureka-client为项目引入了Eureka客户端的jar包，spring-boot-starter-web引入了web场景下，web模块开发所用到的jar包，利用alibaba的fastjson解析json数据，所以引入alibaba.fastjson用到的jar包，mysql-connector-java与spring-boot-starter-data-jpa依赖引入mysql连接使用的jar包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>leyouStorage<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.41<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/01/07/miaosha/MavenImport.png" alt="MavenImport.png"></p><h3 id="4-4-4-配置文件application-properties"><a href="#4-4-4-配置文件application-properties" class="headerlink" title="4.4.4. 配置文件application.properties"></a>4.4.4. 配置文件application.properties</h3><p>在生成的项目中，打开src\man\resources\application.properties，配置端口号等</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">6001</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-storage</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/code1_2?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure><p>在生成的项目中，打开src\main\java\com.itheima.leyou\leyouStorageApplication，在已经生成的启动类中加入 @EnableEurekaClient，意思为启动Eureka客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StorageApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(StorageApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试运行库存服务，在Eureka注册中心中可以看到 leyou-Storage服务，证明服务启动成功</p><p><img src="/2021/01/07/miaosha/eurekaStorage3.png" alt="eurekaStorage3.png"></p><h3 id="4-4-5-创建controller-service-dao文件夹，并创建StorageController-java-StorageService-java-StorageDao-java文件"><a href="#4-4-5-创建controller-service-dao文件夹，并创建StorageController-java-StorageService-java-StorageDao-java文件" class="headerlink" title="4.4.5. 创建controller\service\dao文件夹，并创建StorageController.java\StorageService.java\StorageDao.java文件"></a>4.4.5. 创建controller\service\dao文件夹，并创建StorageController.java\StorageService.java\StorageDao.java文件</h3><p>创建Dao层接口文件，IStorageDao</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IStorageDao</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>给StorageDao.java类增加注解，@Repository用于标注数据访问组件，即DAO组件，实现IStroageDao接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StorageDao</span> <span class="keyword">implements</span> <span class="title">IStorageDao</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>声明 JDBCTemplate 方法，用于连接数据库使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br></pre></td></tr></table></figure><p>创建Service层接口文件，IStorageService</p><p>给StorageService.java类增加注解，实现IStorageService的接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StorageService</span> <span class="keyword">implements</span> <span class="title">IStorageService</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>加入IStorageDao接口的引用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IStorageDao iStorageDao;</span><br></pre></td></tr></table></figure><p>给StorageController.java类增加注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StorageController</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>加入IStorageService接口的引用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IStorageService iStorageService;</span><br></pre></td></tr></table></figure><h3 id="4-4-6-创建查询库存方法（getStockStorage）"><a href="#4-4-6-创建查询库存方法（getStockStorage）" class="headerlink" title="4.4.6. 创建查询库存方法（getStockStorage）"></a>4.4.6. 创建查询库存方法（getStockStorage）</h3><p>用途：查询实际库存是否扣减或增加</p><p>在StorageDao.java类中增加 getStockStorage方法，带一个sku_id参数，意思是通过sku_id进行查找，返回一个商品list，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ArrayList&lt;Map&lt;String, Object&gt;&gt; getStockStorage(String sku_id)&#123;</span><br><span class="line">    <span class="comment">//1、SQL取值</span></span><br><span class="line">    String sql = <span class="string">&quot;SELECT sku_id, quanty FROM tb_stock_storage WHERE sku_id = ?&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、返回数据</span></span><br><span class="line">    <span class="keyword">return</span> (ArrayList&lt;Map&lt;String,Object&gt;&gt;) jdbcTemplate.queryForList(sql, sku_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在StorageService.java类中增加getStockStorage方法，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getStockStorage</span><span class="params">(String sku_id)</span></span>&#123;</span><br><span class="line">    <span class="comment">//1、先取得一个商品的库存</span></span><br><span class="line">    ArrayList&lt;Map&lt;String ,Object&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;Map&lt;String, Object&gt;&gt;();</span><br><span class="line">    list = iStorageDao.getStockStorage(sku_id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、判断如果stockDao取出的商品为空，返回一个提示</span></span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    <span class="keyword">if</span> (list==<span class="keyword">null</span>||list.isEmpty())&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;完了，服务器挂了，数据没取出来！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、判断如果取出的商品不为空，返回数据</span></span><br><span class="line">    resultMap.put(<span class="string">&quot;storage&quot;</span>, list);</span><br><span class="line">    resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在StorageController.java类中增加getStockStorage方法，需要增加注解@RequestMapping，其中value = “/getStockStorage/{sku_id}，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/getStockStorage/&#123;sku_id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getStockStorage</span><span class="params">(<span class="meta">@PathVariable(&quot;sku_id&quot;)</span> String sku_id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> iStorageService.getStockStorage(sku_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-7-创建增减库存方法（insertStorage）"><a href="#4-4-7-创建增减库存方法（insertStorage）" class="headerlink" title="4.4.7. 创建增减库存方法（insertStorage）"></a>4.4.7. 创建增减库存方法（insertStorage）</h3><p>用途：监听队列时，获取消息，扣减库存</p><p>首先要了解库存的表结构：库存主表、库存历史表。库存主表保存的是库存商品现有的剩余数量，库存历史表是保存库存商品出入库的历史。</p><p>例如：A商品库存在a库房里还剩10个，则主表里是a库房，A商品，10个数量</p><p>进货20个，买出10个，则在历史表里有两条记录，一条是入20个，一条是出10个，汇总起来的数量正好等于库存主表的剩余数量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">有人会问了：那查库存数量直接汇总历史表不就可以了？</span><br><span class="line">答案是否，例如京东的销售一件商品会有10万+，那么历史表里有10万+数据，汇总就会很耗时，直接通过主表就可以很轻松的拿到库存剩余数量。</span><br></pre></td></tr></table></figure><p>在StorageDao.java类中增加 insertStorage方法，带三个sku_id，inquanty，outquanty参数，意思是写入哪个库房的哪个商品多少个，返回map，<strong>注意：这里库房是虚拟一个id是1的库房，所以写入的时候直接把warehouse_id赋值为1。</strong></p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">insertStorage</span><span class="params">(String sku_id, <span class="keyword">double</span> in_quanty, <span class="keyword">double</span> out_quanty)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、查询库存主表是否有库存</span></span><br><span class="line">    String sql = <span class="string">&quot;SELECT id FROM tb_stock_storage WHERE sku_id = ?&quot;</span>;</span><br><span class="line">    ArrayList&lt;Map&lt;String, Object&gt;&gt; list = (ArrayList&lt;Map&lt;String, Object&gt;&gt;) jdbcTemplate.queryForList(sql, sku_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> new_id = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">double</span> thisQuanty = in_quanty - out_quanty;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、如果有库存，获取id，作用一写入历史表，作用二反回来更新</span></span><br><span class="line">    <span class="keyword">if</span> (list!=<span class="keyword">null</span>&amp;&amp;list.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        new_id = Integer.parseInt(list.get(<span class="number">0</span>).get(<span class="string">&quot;id&quot;</span>).toString());</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//3、如果没有库存，写入主表库存，并且得到id，作用写入历史表</span></span><br><span class="line">        sql = <span class="string">&quot;INSERT INTO tb_stock_storage (warehouse_id, sku_id, quanty) VALUES (1, &quot;</span>+sku_id+<span class="string">&quot;, &quot;</span>+thisQuanty+<span class="string">&quot;)&quot;</span>;</span><br><span class="line">        KeyHolder keyHolder = <span class="keyword">new</span> GeneratedKeyHolder();</span><br><span class="line">        <span class="keyword">final</span> String finalSql = sql;</span><br><span class="line">        result = jdbcTemplate.update(<span class="keyword">new</span> PreparedStatementCreator() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">createPreparedStatement</span><span class="params">(Connection connection)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">                PreparedStatement preparedStatement = connection.prepareStatement(finalSql, Statement.RETURN_GENERATED_KEYS);</span><br><span class="line">                <span class="keyword">return</span> preparedStatement;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, keyHolder)==<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.1、如果写入失败，返回错误信息 msg</span></span><br><span class="line">        <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">            resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;写入库存主表失败了！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> resultMap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        new_id = keyHolder.getKey().intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4、写入历史表</span></span><br><span class="line">    sql = <span class="string">&quot;INSERT INTO tb_stock_storage_history (stock_storage_id, in_quanty, out_quanty) &quot;</span> +</span><br><span class="line">            <span class="string">&quot;VALUES (?, ?, ?)&quot;</span>;</span><br><span class="line">    result = jdbcTemplate.update(sql, new_id, in_quanty, out_quanty)==<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.1、如果写入失败，返回错误信息 msg</span></span><br><span class="line">    <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;写入库存历史表失败了！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5、如果有库存，反回来更新主表</span></span><br><span class="line">    <span class="keyword">if</span> (list!=<span class="keyword">null</span>&amp;&amp;list.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        sql = <span class="string">&quot;UPDATE tb_stock_storage SET quanty = quanty + ? &quot;</span> +</span><br><span class="line">                <span class="string">&quot;WHERE id = ? AND quanty + ? &gt;= 0&quot;</span>;</span><br><span class="line">        result = jdbcTemplate.update(sql, thisQuanty, new_id, thisQuanty)==<span class="number">1</span>;</span><br><span class="line">        <span class="comment">//5.1、如果写入失败，返回错误信息 msg</span></span><br><span class="line">        <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">            resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;更新库存主表失败了！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> resultMap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6、返回正常数据</span></span><br><span class="line">    resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>首先检查这个商品是否有库存，就是主表是否有这个商品，如果有，证明以前这个商品有入库，所以对库存主表进行更新，如果没有，证明以前这个商品没有入库，所以要写入库存主表，原因是库存主表直接可以查询到库存余额，所以需要直接记录库存余额的数量。</strong></p><p>库存历史表用于记录出入的历史，直接写入即可。</p><p>代码逻辑分析：</p><ul><li>根据库房+商品SKU在库存主表中查询是否有库存</li><li>如果没有，写入库存主表，并得到写入主表的id，这个id用来写入历史表</li><li>如果有，直接根据第一次的查询获取主表的id</li><li>利用获取到的库存主表id写入库存历史表</li><li>统一更新库存主表的数量</li></ul><p>在StorageService.java类中增加insertStorage方法，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">insertStorage</span><span class="params">(String sku_id, <span class="keyword">double</span> in_quanty, <span class="keyword">double</span> out_quanty)</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、传入的参数</span></span><br><span class="line">    <span class="keyword">if</span> (sku_id.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;商品的sku不能为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (in_quanty==<span class="number">0</span>&amp;&amp;out_quanty==<span class="number">0</span>)&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;入库数量和出库数量不能同时为0！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、调StorageDao的方法</span></span><br><span class="line">    resultMap = iStorageDao.insertStorage(sku_id, in_quanty, out_quanty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、返回</span></span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>由于库存属于敏感数据，所以操作库存的时候一定要加以判断，在Service判断逻辑，Dao里判断数据库逻辑。</strong></p><p>在StorageController.java类中增加insertStorage方法，需要增加注解@RequestMapping，其中value = “/insertStorage/{warehouse_id}/{sku_id}/{inquanty}/{outquanty}”，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/insertStorage/&#123;sku_id&#125;/&#123;inquanty&#125;/&#123;outquanty&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">insertStorage</span><span class="params">(<span class="meta">@PathVariable(&quot;sku_id&quot;)</span> String sku_id,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="meta">@PathVariable(&quot;inquanty&quot;)</span> <span class="keyword">double</span> inquanty, <span class="meta">@PathVariable(&quot;outquanty&quot;)</span> <span class="keyword">double</span> outquanty)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> iStorageService.insertStorage(sku_id, inquanty, outquanty);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-8-测试库存增减"><a href="#4-4-8-测试库存增减" class="headerlink" title="4.4.8. 测试库存增减"></a>4.4.8. 测试库存增减</h3><p>直接通过页面访问 getStorageQuanty 方法，查询现有数量，再用insertStorage 方法增减，最后通过 getStorageQuanty 方法再查询</p><p>查询库存的地址为：<a target="_blank" rel="noopener" href="http://localhost:6001/getStockStorage/26816294479">http://localhost:6001/getStockStorage/26816294479</a></p><p><img src="/2021/01/07/miaosha/insertStorage1.png" alt="insertStorage1.png"></p><p>先查询一下库存有990个</p><p><img src="/2021/01/07/miaosha/insertStorage2.png" alt="insertStorage2.png"></p><p>再通过insertStorage方法增减库存，这里展示减10个，</p><p>写入库存的地址为：<a target="_blank" rel="noopener" href="http://localhost:6001/insertStorage/26816294479/0/10">http://localhost:6001/insertStorage/26816294479/0/10</a></p><p><img src="/2021/01/07/miaosha/insertStorage3.png" alt="insertStorage3.png"></p><p>最后查询一次库存有980个，</p><p>查询库存的地址为：<a target="_blank" rel="noopener" href="http://localhost:6001/getStockStorage/26816294479">http://localhost:6001/getStockStorage/26816294479</a></p><h3 id="4-4-9-处理库存队列监听方法（storage-queue）"><a href="#4-4-9-处理库存队列监听方法（storage-queue）" class="headerlink" title="4.4.9. 处理库存队列监听方法（storage_queue）"></a>4.4.9. 处理库存队列监听方法（storage_queue）</h3><p>新增依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在src\main\java\com\itheima\leyou\文件夹下新建文件夹queue，在queue文件夹下新建java文件StorageQueue</p><p><img src="/2021/01/07/miaosha/storagequeue1.png" alt="storagequeue1.png"></p><p>在StorageQueue.java里写入队列监听方法，调用iStorageService.insertStorage来写入库存，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StorageQueue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IStorageService iStorageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;storage_queue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getStorageQueue</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;storage_queue接收消息：&quot;</span>+msg);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = iStorageService.insertStorage(msg, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!(Boolean) result.get(<span class="string">&quot;result&quot;</span>))&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;storage_queue消息处理失败：&quot;</span>+result.get(<span class="string">&quot;msg&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;storage_queue消息处理失败：&quot;</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;storage_queue消息处理完毕！&quot;</span>+result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-5-创建会员服务（端口号5000）"><a href="#4-5-创建会员服务（端口号5000）" class="headerlink" title="4.5. 创建会员服务（端口号5000）"></a>4.5. 创建会员服务（端口号5000）</h2><hr><h3 id="4-5-1-创建会员表结构"><a href="#4-5-1-创建会员表结构" class="headerlink" title="4.5.1. 创建会员表结构"></a>4.5.1. 创建会员表结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `tb_user`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_user` (</span><br><span class="line">  `id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `username` <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `password` <span class="type">VARCHAR</span>(<span class="number">60</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码，加密存储&#x27;</span>,</span><br><span class="line">  `phone` <span class="type">VARCHAR</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;注册手机号&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">TIMESTAMP</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">TIMESTAMP</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `username` (`username`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `phone` (`phone`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">31</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;用户表&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-5-2-创建会员服务"><a href="#4-5-2-创建会员服务" class="headerlink" title="4.5.2. 创建会员服务"></a>4.5.2. 创建会员服务</h3><p>第一步：选择File-New-Module…，弹出的窗口中选择Spring initializr，选择Module SDK，选择Next</p><p>第二步：Group为com.itheima，Artifact为leyou，Name为leyouUser，Description为User For leyou Project，选择Next</p><p>第三步：选择 Spring Cloud Discovery，选择 Eureka Discovery Client，选择Next</p><p>第四步：Module name 为 leyouUser，Content root为路径+leyouUser，选择Finish，此时在项目文件夹下会创建一个 leyouUser文件夹</p><h3 id="4-5-3-配置pom-xml"><a href="#4-5-3-配置pom-xml" class="headerlink" title="4.5.3. 配置pom.xml"></a>4.5.3. 配置pom.xml</h3><p>在生成的项目中，打开pom.xml，配置依赖，其中spring-cloud-starter-netflix-eureka-client为项目引入了Eureka客户端的jar包，spring-boot-starter-web引入了web场景下，web模块开发所用到的jar包，利用alibaba的fastjson解析json数据，所以引入alibaba.fastjson用到的jar包，mysql-connector-java与spring-boot-starter-data-jpa依赖引入mysql连接使用的jar包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>leyouUser<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.41<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/01/07/miaosha/MavenImport.png" alt="MavenImport.png"></p><h3 id="4-5-4-配置文件application-properties"><a href="#4-5-4-配置文件application-properties" class="headerlink" title="4.5.4. 配置文件application.properties"></a>4.5.4. 配置文件application.properties</h3><p>在生成的项目中，打开src\man\resources\application.properties，配置端口号等</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">5000</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-user</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/code1_2?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#redis数据库编号，存在0~15共16个数据库</span></span><br><span class="line"><span class="meta">spring.redis.database</span>=<span class="string">0</span></span><br><span class="line"><span class="comment">#redis服务器IP</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment">#redis端口号</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="comment">#redis密码</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string">leyou</span></span><br><span class="line"><span class="comment">#redis请求超时时间，超过此值redis自动断开连接</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">10000ms</span></span><br><span class="line"><span class="comment">#jedis最大连接数，超过此值则提示获取不到连接异常</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-active</span>=<span class="string">32</span></span><br><span class="line"><span class="comment">#jedis最大等待时间，超过此值会提示连接超时异常</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-wait</span>=<span class="string">10000ms</span></span><br><span class="line"><span class="comment">#jedis最大等待连接数</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-idle</span>=<span class="string">32</span></span><br><span class="line"><span class="comment">#jedis最小等待连接数</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure><p>在生成的项目中，打开src\main\java\com.itheima.leyou\leyouUserApplication，在已经生成的启动类中加入 @EnableEurekaClient，意思为启动Eureka客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(UserApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>测试运行订单服务，在Eureka注册中心中可以看到 leyou-User服务，证明服务启动成功</p><h3 id="4-5-5-创建controller-service-dao文件夹，并创建UserController-java-UserService-java-UserDao-java文件"><a href="#4-5-5-创建controller-service-dao文件夹，并创建UserController-java-UserService-java-UserDao-java文件" class="headerlink" title="4.5.5. 创建controller\service\dao文件夹，并创建UserController.java\UserService.java\UserDao.java文件"></a>4.5.5. 创建controller\service\dao文件夹，并创建UserController.java\UserService.java\UserDao.java文件</h3><p>创建Dao层接口文件，IUserDao</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserDao</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>给UserDao.java类增加注解，@Repository用于标注数据访问组件，即DAO组件，实现IUserDao的接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> <span class="keyword">implements</span> <span class="title">IUserDao</span> </span>&#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>声明 JDBCTemplate 方法，用于连接数据库使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br></pre></td></tr></table></figure><p>创建Service层接口，IUserService</p><p>给UserService.java类增加注解，实现IUserService接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">implements</span> <span class="title">IUserService</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>加入UserDao的引用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IUserDao iUserDao;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>给UserController.java类增加注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>加入UserService接口的引用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IUserService iUserService;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-5-6-创建查询会员方法（getUser）"><a href="#4-5-6-创建查询会员方法（getUser）" class="headerlink" title="4.5.6. 创建查询会员方法（getUser）"></a>4.5.6. 创建查询会员方法（getUser）</h3><p>用途：给前端提供会员信息数据，主要用于前端会员登录</p><p>在UserDao.java类中增加 getUser方法，带两个username，password参数，意思是通过username和password进行查找，返回一个会员List，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ArrayList&lt;Map&lt;String, Object&gt;&gt; getUser(String username, String password)&#123;</span><br><span class="line">    String sql = <span class="string">&quot;select id AS user_id, username, phone, password from tb_user where username = ?&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> (ArrayList&lt;Map&lt;String,Object&gt;&gt;) jdbcTemplate.queryForList(sql, username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在UserService.java类中增加getUser方法，返回一个商品List，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getUser</span><span class="params">(String username, String password)</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    <span class="comment">//1、判断传入的参数是否有误</span></span><br><span class="line">    <span class="keyword">if</span> (username==<span class="keyword">null</span>||username.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;用户名不能为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、取会员列表</span></span><br><span class="line">    ArrayList&lt;Map&lt;String, Object&gt;&gt; list = iUserDao.getUser(username, password);</span><br><span class="line">    <span class="keyword">if</span> (list==<span class="keyword">null</span>||list.isEmpty())&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;没找到会员信息！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    resultMap = list.get(<span class="number">0</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-5-7-创建增加会员方法（insertUser）"><a href="#4-5-7-创建增加会员方法（insertUser）" class="headerlink" title="4.5.7. 创建增加会员方法（insertUser）"></a>4.5.7. 创建增加会员方法（insertUser）</h3><p>用途：给前端提供会员信息增加，主要用于前端会员注册</p><p>在UserDao.java类中增加 insertUser方法，带username，phone，password三个参数，返回一个Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertUser</span><span class="params">(String username, String password)</span></span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String sql = <span class="string">&quot;insert into tb_user (username, phone, password) values (&#x27;&quot;</span>+username+<span class="string">&quot;&#x27;, &#x27;&quot;</span>+username+<span class="string">&quot;&#x27;, &#x27;&quot;</span>+password+<span class="string">&quot;&#x27;)&quot;</span>;</span><br><span class="line">    KeyHolder keyHolder = <span class="keyword">new</span> GeneratedKeyHolder();</span><br><span class="line">    jdbcTemplate.update(<span class="keyword">new</span> PreparedStatementCreator() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">createPreparedStatement</span><span class="params">(Connection connection)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">            PreparedStatement preparedStatement = connection.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);</span><br><span class="line">            <span class="keyword">return</span> preparedStatement;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, keyHolder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> keyHolder.getKey().intValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码分析：</p><ul><li>根据手机号先查询是否存在该用户</li><li>如果存在则提示该用户已经存在</li><li>根据三个参数写入会员表中</li><li>写入正确则返回result为true，写入错误则返回result为false</li></ul><p>在UserService.java类中增加insertUser方法，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">insertUser</span><span class="params">(String username, String password)</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    <span class="comment">//1、判断传入的参数是否有误</span></span><br><span class="line">    <span class="keyword">if</span> (username==<span class="keyword">null</span>||username.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;用户名不能为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> user_id = iUserDao.insertUser(username, password);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (user_id&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;数据库没有执行成功！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    resultMap.put(<span class="string">&quot;user_id&quot;</span>, user_id);</span><br><span class="line">    resultMap.put(<span class="string">&quot;username&quot;</span>, username);</span><br><span class="line">    resultMap.put(<span class="string">&quot;phone&quot;</span>, username);</span><br><span class="line">    resultMap.put(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">    resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意：这里的Service有业务逻辑判断，如果Json转化错误或传入参数为空时，会导致数据库写入报错，因此在传入Dao层之前进行判断，传入的参数是否合法。解析出来的json也需要判断，用户名和电话不能为空</strong></p><h3 id="4-5-8-在UserController-java类中增加login方法"><a href="#4-5-8-在UserController-java类中增加login方法" class="headerlink" title="4.5.8. 在UserController.java类中增加login方法"></a>4.5.8. 在UserController.java类中增加login方法</h3><p>需要增加注解@RequestMapping，其中value = “/login，返回一个Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/login&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">login</span><span class="params">(String username, String password, HttpServletRequest httpServletRequest)</span></span>&#123;</span><br><span class="line">    <span class="comment">//1、取会员</span></span><br><span class="line">    Map&lt;String, Object&gt; userMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    userMap = iUserService.getUser(username, password);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、没取到会员，写入会员</span></span><br><span class="line">    <span class="keyword">if</span> (!(Boolean) userMap.get(<span class="string">&quot;result&quot;</span>))&#123;</span><br><span class="line">        userMap = iUserService.insertUser(username, password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、写入session</span></span><br><span class="line">    HttpSession httpSession = httpServletRequest.getSession();</span><br><span class="line">    String user = JSON.toJSONString(userMap);</span><br><span class="line">    httpSession.setAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line"></span><br><span class="line">    Object o = httpSession.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4、返回信息</span></span><br><span class="line">    <span class="keyword">return</span> userMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码分析：</p><ul><li>login既用到了会员查询方法（getUser），又用到了会员增加方法（insertUser）</li><li>先根据前端页面传入的电话和密码查找会员，如果找到了，直接登录，如果没找到，直接注册一个，一般的实际项目中，这里会有两个验证的环节，一个是验证码，主要用于验证手机号；一个是图片验证，主要防止短信轰炸。</li><li>将会员信息写入session</li></ul><h2 id="4-6-创建订单服务（端口号4000）"><a href="#4-6-创建订单服务（端口号4000）" class="headerlink" title="4.6. 创建订单服务（端口号4000）"></a>4.6. 创建订单服务（端口号4000）</h2><hr><h3 id="4-6-1-创建订单表结构"><a href="#4-6-1-创建订单表结构" class="headerlink" title="4.6.1. 创建订单表结构"></a>4.6.1. 创建订单表结构</h3><p>1、订单主表</p><p>用途：用于存储订单主表信息，例如：整单金额、会员、支付类型、付款时间等。</p><p>2、订单明细表</p><p>用途：用于存订单明细，和订单主表进行关联，一张订单可能会有多个明细，例如：一个会员买了多件商品，每一条明细的数量、单价、金额等。</p><p>3、订单物流状态表</p><p>用途：用于存储订单的物流状态，和订单主表进行关联，一张订单会有多个明细状态，例如：每个商品的物流公司、物流状态、是否签收等。</p><h3 id="4-6-2-创建订单服务"><a href="#4-6-2-创建订单服务" class="headerlink" title="4.6.2. 创建订单服务"></a>4.6.2. 创建订单服务</h3><p>第一步：选择File-New-Module…，弹出的窗口中选择Spring initializr，选择Module SDK，选择Next</p><p>第二步：Group为com.itheima，Artifact为leyou，Name为leyouOrder，Description为Order For leyou Project，选择Next</p><p>第三步：选择 Spring Cloud Discovery，选择 Eureka Discovery Client，选择Next</p><p>第四步：Module name 为 leyouOrder，Content root为路径+leyouOrder，选择Finish，此时在项目文件夹下会创建一个 leyouOrder文件夹</p><h3 id="4-6-3-配置pom-xml"><a href="#4-6-3-配置pom-xml" class="headerlink" title="4.6.3. 配置pom.xml"></a>4.6.3. 配置pom.xml</h3><p>在生成的项目中，打开pom.xml，配置依赖，其中spring-cloud-starter-netflix-eureka-client为项目引入了Eureka客户端的jar包，spring-boot-starter-web引入了web场景下，web模块开发所用到的jar包，利用alibaba的fastjson解析json数据，所以引入alibaba.fastjson用到的jar包，mysql-connector-java与spring-boot-starter-data-jpa依赖引入mysql连接使用的jar包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>leyouOrder<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.41<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/01/07/miaosha/MavenImport.png" alt="MavenImport.png"></p><h3 id="4-6-4-配置文件application-properties"><a href="#4-6-4-配置文件application-properties" class="headerlink" title="4.6.4. 配置文件application.properties"></a>4.6.4. 配置文件application.properties</h3><p>在生成的项目中，打开src\man\resources\application.properties，配置端口号等</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">4000</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-order</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/code1_2?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#redis数据库编号，存在0~15共16个数据库</span></span><br><span class="line"><span class="meta">spring.redis.database</span>=<span class="string">0</span></span><br><span class="line"><span class="comment">#redis服务器IP</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment">#redis端口号</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="comment">#redis密码</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string">leyou</span></span><br><span class="line"><span class="comment">#redis请求超时时间，超过此值redis自动断开连接</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">10000ms</span></span><br><span class="line"><span class="comment">#jedis最大连接数，超过此值则提示获取不到连接异常</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-active</span>=<span class="string">32</span></span><br><span class="line"><span class="comment">#jedis最大等待时间，超过此值会提示连接超时异常</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-wait</span>=<span class="string">10000ms</span></span><br><span class="line"><span class="comment">#jedis最大等待连接数</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-idle</span>=<span class="string">32</span></span><br><span class="line"><span class="comment">#jedis最小等待连接数</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure><p>在生成的项目中，打开src\main\java\com.itheima.leyou\leyouOrderApplication，在已经生成的启动类中加入 @EnableEurekaClient，意思为启动Eureka客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试运行订单服务，在Eureka注册中心中可以看到 leyou-Order服务，证明服务启动成功</p><h3 id="4-6-5-创建controller-service-dao文件夹，并创建OrderController-java-OrderService-java-OrderDao-java文件"><a href="#4-6-5-创建controller-service-dao文件夹，并创建OrderController-java-OrderService-java-OrderDao-java文件" class="headerlink" title="4.6.5. 创建controller\service\dao文件夹，并创建OrderController.java\OrderService.java\OrderDao.java文件"></a>4.6.5. 创建controller\service\dao文件夹，并创建OrderController.java\OrderService.java\OrderDao.java文件</h3><p>创建Dao层接口文件，IOrderDao</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IOrderDao</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>给OrderDao.java类增加注解，@Repository用于标注数据访问组件，即DAO组件，实现IOrderDao接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDao</span> <span class="keyword">implements</span> <span class="title">IOrderDao</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>声明 JDBCTemplate 方法，用于连接数据库使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">JdbcTemplate jdbcTemplate;</span><br></pre></td></tr></table></figure><p>创建Service层接口文件，IOrderService</p><p>给OrderService.java类增加注解，实现IOrderService接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> <span class="keyword">implements</span> <span class="title">IOrderService</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>加入IOrderDao的引用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IOrderDao iOrderDao;</span><br></pre></td></tr></table></figure><p>给OrderController.java类增加注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>加入IOrderService的引用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IOrderService iOrderService;</span><br></pre></td></tr></table></figure><h3 id="4-6-6-增加创建订单方法（createOrder）"><a href="#4-6-6-增加创建订单方法（createOrder）" class="headerlink" title="4.6.6. 增加创建订单方法（createOrder）"></a>4.6.6. 增加创建订单方法（createOrder）</h3><p>主要用于前端提交订单页面调用，并写入订单队列，</p><p><strong>注意：这里需要返回 order_id，支付页面通过 order_id进行查询。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">createOrder</span><span class="params">(String sku_id, String user_id)</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    <span class="comment">//1、判断sku_id</span></span><br><span class="line">    <span class="keyword">if</span> (sku_id==<span class="keyword">null</span>||sku_id.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;前端又传错了！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、取redis政策</span></span><br><span class="line">    String order_id = String.valueOf(System.currentTimeMillis());</span><br><span class="line">    String policy = stringRedisTemplate.opsForValue().get(<span class="string">&quot;LIMIT_POLICY_&quot;</span>+sku_id);</span><br><span class="line">    <span class="keyword">if</span> (policy!=<span class="keyword">null</span>&amp;&amp;!policy.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">        <span class="comment">//3、开始时间小于等于当前时间，当前时间小于等于结束</span></span><br><span class="line">        Map&lt;String, Object&gt; policyMap = JSONObject.parseObject(policy, Map.class);</span><br><span class="line"></span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>);</span><br><span class="line">        String now = restTemplate.getForObject(<span class="string">&quot;http://leyou-time-server/getTime&quot;</span>, String.class);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Date begin_time = simpleDateFormat.parse(policyMap.get(<span class="string">&quot;begin_time&quot;</span>).toString());</span><br><span class="line">            Date end_time = simpleDateFormat.parse(policyMap.get(<span class="string">&quot;end_time&quot;</span>).toString());</span><br><span class="line">            Date now_time = simpleDateFormat.parse(now);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (begin_time.getTime()&lt;=now_time.getTime()&amp;&amp;now_time.getTime()&lt;=end_time.getTime())&#123;</span><br><span class="line">                <span class="keyword">int</span> limitQuanty = Integer.parseInt(policyMap.get(<span class="string">&quot;quanty&quot;</span>).toString());</span><br><span class="line"></span><br><span class="line">                <span class="comment">//4、redis计数器</span></span><br><span class="line">                <span class="comment">// +1+1+1=3  4</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (stringRedisTemplate.opsForValue().increment(<span class="string">&quot;SKU_QUANTY_&quot;</span>+sku_id, <span class="number">1</span>)&lt;=limitQuanty)&#123;</span><br><span class="line">                    <span class="comment">//5、写入队列</span></span><br><span class="line">                    <span class="comment">// tb_order: order_id, total_fee, actual_fee, post_fee, payment_type, user_id, status, create_time</span></span><br><span class="line">                    <span class="comment">// tb_order_detail: order_id, sku_id, num, title, own_spec, price, image, create_time</span></span><br><span class="line">                    <span class="comment">// tb_sku: sku_id, title, images, stock, price, indexes, own_spec</span></span><br><span class="line"></span><br><span class="line">                    String sku = stringRedisTemplate.opsForValue().get(<span class="string">&quot;SKU_&quot;</span>+sku_id);</span><br><span class="line">                    Map&lt;String, Object&gt; skuMap = JSONObject.parseObject(sku, Map.class);</span><br><span class="line"></span><br><span class="line">                    Map&lt;String, Object&gt; orderInfo = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;order_id&quot;</span>, order_id);</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;total_fee&quot;</span>, skuMap.get(<span class="string">&quot;price&quot;</span>));</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;actual_fee&quot;</span>, policyMap.get(<span class="string">&quot;price&quot;</span>));</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;post_fee&quot;</span>, <span class="number">0</span>);</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;payment_type&quot;</span>, <span class="number">0</span>);</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;user_id&quot;</span>, user_id);</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;status&quot;</span>, <span class="number">1</span>);</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;create_time&quot;</span>, now);</span><br><span class="line"></span><br><span class="line">                    orderInfo.put(<span class="string">&quot;sku_id&quot;</span>, skuMap.get(<span class="string">&quot;sku_id&quot;</span>));</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;num&quot;</span>, <span class="number">1</span>);</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;title&quot;</span>, skuMap.get(<span class="string">&quot;title&quot;</span>));</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;own_spec&quot;</span>, skuMap.get(<span class="string">&quot;own_spec&quot;</span>));</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;price&quot;</span>, policyMap.get(<span class="string">&quot;price&quot;</span>));</span><br><span class="line">                    orderInfo.put(<span class="string">&quot;image&quot;</span>, skuMap.get(<span class="string">&quot;images&quot;</span>));</span><br><span class="line"></span><br><span class="line">                    String order = JSON.toJSONString(orderInfo);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        amqpTemplate.convertAndSend(<span class="string">&quot;order_queue&quot;</span>, order);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">                        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;写入队列异常！&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> resultMap;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//如果超出了计数器，返回商品已经售完了</span></span><br><span class="line">                    resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">                    resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;3亿9被踢回去了！&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> resultMap;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//如果结束时间大于当前时间，返回活动已经过期</span></span><br><span class="line">                resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">                resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;活动已经过期！&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> resultMap;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//政策没有取出数，返回活动已经过期</span></span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;活动已经过期！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6、返回正常数据，带着订单号</span></span><br><span class="line">    resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;order_id&quot;</span>, order_id);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在OrderController.java里增加创建订单的方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/createOrder/&#123;sku_id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">createOrder</span><span class="params">(<span class="meta">@PathVariable(&quot;sku_id&quot;)</span> String sku_id, HttpServletRequest httpServletRequest)</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    HttpSession httpSession = httpServletRequest.getSession();</span><br><span class="line">    Object userObj = httpSession.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userObj==<span class="keyword">null</span>)&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;会员没有登录不能购买！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line">    Map&lt;String, Object&gt; userMap = JSONObject.parseObject(userObj.toString(), Map.class);</span><br><span class="line">    <span class="keyword">return</span> iOrderService.createOrder(sku_id, userMap.get(<span class="string">&quot;user_id&quot;</span>).toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意：需要从session里取值，如果没有取到会员信息则不能购买！</strong></p><h3 id="4-6-7-创建写入订单方法（insertOrder）"><a href="#4-6-7-创建写入订单方法（insertOrder）" class="headerlink" title="4.6.7. 创建写入订单方法（insertOrder）"></a>4.6.7. 创建写入订单方法（insertOrder）</h3><p>主要应用于队列写入订单，在OrderDao.java中增加insertOrder方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">insertOrder</span><span class="params">(Map&lt;String, Object&gt; orderInfo)</span></span>&#123;</span><br><span class="line">    <span class="comment">//写入主表</span></span><br><span class="line">    String sql = <span class="string">&quot;insert into tb_order (order_id, total_fee, actual_fee, post_fee, payment_type, user_id, status, create_time) &quot;</span> +</span><br><span class="line">            <span class="string">&quot;values (?, ?, ?, ?, ?, ?, ?, ?)&quot;</span>;</span><br><span class="line">    <span class="keyword">boolean</span> result = jdbcTemplate.update(sql, orderInfo.get(<span class="string">&quot;order_id&quot;</span>), orderInfo.get(<span class="string">&quot;total_fee&quot;</span>), orderInfo.get(<span class="string">&quot;actual_fee&quot;</span>),</span><br><span class="line">            orderInfo.get(<span class="string">&quot;post_fee&quot;</span>), orderInfo.get(<span class="string">&quot;payment_type&quot;</span>), orderInfo.get(<span class="string">&quot;user_id&quot;</span>), orderInfo.get(<span class="string">&quot;status&quot;</span>),</span><br><span class="line">            orderInfo.get(<span class="string">&quot;create_time&quot;</span>))==<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写入明细表</span></span><br><span class="line">    <span class="keyword">if</span> (result)&#123;</span><br><span class="line">        sql = <span class="string">&quot;INSERT INTO tb_order_detail (order_id, sku_id, num, title, own_spec, price, image, create_time) &quot;</span> +</span><br><span class="line">                <span class="string">&quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?)&quot;</span>;</span><br><span class="line">        result = jdbcTemplate.update(sql, orderInfo.get(<span class="string">&quot;order_id&quot;</span>), orderInfo.get(<span class="string">&quot;sku_id&quot;</span>), orderInfo.get(<span class="string">&quot;num&quot;</span>),</span><br><span class="line">                orderInfo.get(<span class="string">&quot;title&quot;</span>), orderInfo.get(<span class="string">&quot;own_spec&quot;</span>), orderInfo.get(<span class="string">&quot;price&quot;</span>), orderInfo.get(<span class="string">&quot;image&quot;</span>), orderInfo.get(<span class="string">&quot;create_time&quot;</span>))==<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在OrderService.java里增加insertOrder方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">insertOrder</span><span class="params">(Map&lt;String, Object&gt; orderInfo)</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    <span class="keyword">if</span> (orderInfo==<span class="keyword">null</span>||orderInfo.isEmpty())&#123;</span><br><span class="line">        map.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        map.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;传入参数有误！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> result = iOrderDao.insertOrder(orderInfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">        map.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        map.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;订单写入失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    map.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    map.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由队列调用iOrderService.insertOrder</p><h3 id="4-6-8-创建订单队列（order-queue）"><a href="#4-6-8-创建订单队列（order-queue）" class="headerlink" title="4.6.8. 创建订单队列（order_queue）"></a>4.6.8. 创建订单队列（order_queue）</h3><p>需要的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在src\main\java\com\itheima\leyou\文件夹下新建文件夹queue，在queue文件夹下新建java文件OrderQueue</p><p><img src="/2021/01/07/miaosha/orderqueue1.png" alt="orderqueue1.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderQueue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IOrderService iOrderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;order_queue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertOrder</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        <span class="comment">//1、接收消息并输出</span></span><br><span class="line">        System.out.println(<span class="string">&quot;order_queue接收消息：&quot;</span>+msg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、调用一个写入订单方法</span></span><br><span class="line">        Map&lt;String, Object&gt; orderInfo = JSONObject.parseObject(msg, Map.class);</span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        resultMap = iOrderService.insertOrder(orderInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、如果没写成功输出错误消息</span></span><br><span class="line">        <span class="keyword">if</span> (!(Boolean) resultMap.get(<span class="string">&quot;result&quot;</span>))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;order_queue处理消息失败：&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、成功输出消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;order_queue处理消息成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-6-9-测试创建订单"><a href="#4-6-9-测试创建订单" class="headerlink" title="4.6.9. 测试创建订单"></a>4.6.9. 测试创建订单</h3><p>先将session的判断挂起，user_id赋值为1。</p><p>在浏览器里输入 <a target="_blank" rel="noopener" href="http://localhost:4000/createOrder/26816294479">http://localhost:4000/createOrder/26816294479</a></p><p><img src="/2021/01/07/miaosha/createOrder.png" alt="createOrder.png"></p><p><img src="/2021/01/07/miaosha/createOrder1.png" alt="createOrder1.png"></p><p>队列也处理成功。</p><h3 id="4-6-10-创建查询订单方法（getOrder）"><a href="#4-6-10-创建查询订单方法（getOrder）" class="headerlink" title="4.6.10. 创建查询订单方法（getOrder）"></a>4.6.10. 创建查询订单方法（getOrder）</h3><p>用途：查询订单详情，用于会员中心–我的订单查询</p><p>首先了解订单的表结构为：订单主表、订单明细表、订单物流状态表，一张订单有一个主表，多个明细，多个物流状态。</p><p>在OrderDao.java类中增加 getOrder方法，带一个orderid参数，意思是通过orderid进行查找，返回一个订单map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ArrayList&lt;Map&lt;String, Object&gt;&gt; getOrder(String order_id)&#123;</span><br><span class="line">    String sql = <span class="string">&quot;select d.sku_id, m.order_id, d.price &quot;</span> +</span><br><span class="line">            <span class="string">&quot;from tb_order m inner join tb_order_detail d on m.order_id = d.order_id &quot;</span> +</span><br><span class="line">            <span class="string">&quot;where m.order_id = ?&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> (ArrayList&lt;Map&lt;String, Object&gt;&gt;) jdbcTemplate.queryForList(sql, order_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在StorageService.java类中增加getOrder方法，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getOrder</span><span class="params">(String order_id)</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (order_id==<span class="keyword">null</span>||order_id.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;参数传入有误！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;Map&lt;String, Object&gt;&gt; list = iOrderDao.getOrder(order_id);</span><br><span class="line">    resultMap.put(<span class="string">&quot;order&quot;</span>, list);</span><br><span class="line">    resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在StorageController.java类中增加getOrder方法，需要增加注解@RequestMapping，其中value = “/getOrder/{orderid}，返回一个商品Map，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/getOrder/&#123;order_id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getOrder</span><span class="params">(<span class="meta">@PathVariable(&quot;order_id&quot;)</span> String order_id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> iOrderService.getOrder(order_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-6-11-创建更新订单状态方法（updateOrderStatus）"><a href="#4-6-11-创建更新订单状态方法（updateOrderStatus）" class="headerlink" title="4.6.11. 创建更新订单状态方法（updateOrderStatus）"></a>4.6.11. 创建更新订单状态方法（updateOrderStatus）</h3><p>主要应用于队列更新订单状态的方法，在OrderDao.java中增加updateOrderStatus方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateOrderStatus</span><span class="params">(String order_id)</span></span>&#123;</span><br><span class="line">    String sql = <span class="string">&quot;update tb_order set status = 2 where order_id = ?&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.update(sql, order_id)==<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-6-12-创建订单支付方法（payOrder）"><a href="#4-6-12-创建订单支付方法（payOrder）" class="headerlink" title="4.6.12. 创建订单支付方法（payOrder）"></a>4.6.12. 创建订单支付方法（payOrder）</h3><p>主要用于前端支付页面调用，并写入订单状态更新队列</p><p>在OrderService.java中增加payOrder方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">payOrder</span><span class="params">(String order_id, String sku_id)</span></span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    <span class="keyword">if</span> (order_id==<span class="keyword">null</span>||order_id.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;订单有误！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> result = iOrderDao.updateOrderStatus(order_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result)&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;订单状态更新失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    amqpTemplate.convertAndSend(<span class="string">&quot;storage_queue&quot;</span>, sku_id);</span><br><span class="line"></span><br><span class="line">    resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在OrderController.java中增加payOrder方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/payOrder/&#123;order_id&#125;/&#123;sku_id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">payOrder</span><span class="params">(<span class="meta">@PathVariable(&quot;order_id&quot;)</span> String order_id, <span class="meta">@PathVariable(&quot;sku_id&quot;)</span> String sku_id)</span></span>&#123;</span><br><span class="line">    <span class="comment">//正常情况下在这里会调用支付接口，我们这里模拟支付已经返回正常数据</span></span><br><span class="line">    <span class="keyword">boolean</span> isPay = <span class="keyword">true</span>;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    <span class="keyword">if</span> (!isPay)&#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;result&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;支付接口调用失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> iOrderService.payOrder(order_id, sku_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-6-13-测试查询订单"><a href="#4-6-13-测试查询订单" class="headerlink" title="4.6.13. 测试查询订单"></a>4.6.13. 测试查询订单</h3><p>直接通过页面访问 getOrder 方法查询，<a target="_blank" rel="noopener" href="http://localhost:4000/getOrder/1565019341112">http://localhost:4000/getOrder/1565019341112</a></p><p><img src="/2021/01/07/miaosha/getorder.png" alt="getorder.png"></p><h2 id="4-7-创建网关服务（端口号80）"><a href="#4-7-创建网关服务（端口号80）" class="headerlink" title="4.7. 创建网关服务（端口号80）"></a>4.7. 创建网关服务（端口号80）</h2><hr><h3 id="4-7-1-创建网关服务"><a href="#4-7-1-创建网关服务" class="headerlink" title="4.7.1. 创建网关服务"></a>4.7.1. 创建网关服务</h3><p>第一步：选择File-New-Module…，弹出的窗口中选择Spring initializr，选择Module SDK，选择Next</p><p>第二步：Group为com.itheima，Artifact为leyou，Name为ZuulServer，Description为Zuul For leyou Project，选择Next</p><p>第三步：选择 Spring Cloud Discovery，选择 Eureka Discovery Client，选择Next</p><p>第四步：Module name 为 ZuulServer，Content root为路径+ZuulServer，选择Finish，此时在项目文件夹下会创建一个 ZuulServer文件夹</p><h3 id="4-7-2-配置pom-xml"><a href="#4-7-2-配置pom-xml" class="headerlink" title="4.7.2. 配置pom.xml"></a>4.7.2. 配置pom.xml</h3><p>在生成的项目中，打开pom.xml，配置依赖，其中spring-cloud-starter-netflix-eureka-client为项目引入了Eureka客户端的jar包，spring-boot-starter-web引入了web场景下，web模块开发所用到的jar包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>leyouZuul<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/01/07/miaosha/MavenImport.png" alt="MavenImport.png"></p><h3 id="4-7-3-配置文件application-properties"><a href="#4-7-3-配置文件application-properties" class="headerlink" title="4.7.3. 配置文件application.properties"></a>4.7.3. 配置文件application.properties</h3><p>在生成的项目中，打开src\man\resources\application.properties，配置端口号等</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">80</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-zuul</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#忽略框架默认的服务映射路径</span></span><br><span class="line"><span class="meta">zuul.ignored-services</span>=<span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="comment">#不忽略框架与权限相关的头信息</span></span><br><span class="line"><span class="meta">zuul.ignore-security-headers</span>=<span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="meta">zuul.host.socket-timeout-millis</span>=<span class="string">60000</span></span><br><span class="line"><span class="meta">zuul.host.connect-timeout-millis</span>=<span class="string">60000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">zuul.host.max-total-connections</span>=<span class="string">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">zuul.routes.leyou-client.path</span>=<span class="string">/leyouClient/**</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-client.serviceId</span>=<span class="string">leyou-client</span></span><br><span class="line"><span class="comment">#防止session不一致问题</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-client.sensitiveHeaders</span>=<span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">zuul.routes.leyou-order.path</span>=<span class="string">/leyouOrder/**</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-order.serviceId</span>=<span class="string">leyou-order</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-order.sensitiveHeaders</span>=<span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">zuul.routes.leyou-user.path</span>=<span class="string">/leyouUser/**</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-user.serviceId</span>=<span class="string">leyou-user</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-user.sensitiveHeaders</span>=<span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">zuul.routes.leyou-stock.path</span>=<span class="string">/leyouStock/**</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-stock.serviceId</span>=<span class="string">leyou-stock</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-stock.sensitiveHeaders</span>=<span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">zuul.routes.leyou-storage.path</span>=<span class="string">/leyouStorage/**</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-storage.serviceId</span>=<span class="string">leyou-storage</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-storage.sensitiveHeaders</span>=<span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">zuul.routes.leyou-time-server.path</span>=<span class="string">/leyouTimeServer/**</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-time-server.serviceId</span>=<span class="string">leyou-time-server</span></span><br><span class="line"><span class="meta">zuul.routes.leyou-time-server.sensitiveHeaders</span>=<span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure><p>zuul.routes.leyou-order.path为每个服务的路径</p><p>zuul.routes.leyou-stock.serviceId为每个服务的编号</p><p>以此类推，将所有服务进行配置</p><p><strong>注意：zuul使用80端口，在访问的时候可以不用输入端口号。</strong></p><p>在生成的项目中，打开src\main\java\com.itheima.leyou\leyouTimeServerApplication，在已经生成的启动类中加入 @EnableZuulProxy，当Zuul与Eureka、Ribbon等组件配合使用时，我们使用@EnableZuulProxy</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(ZuulApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试运行网关服务，利用前面的查询库存的方法：getStockStorage</p><p><img src="/2021/01/07/miaosha/zuul1.png" alt="zuul1.png"></p><p><img src="/2021/01/07/miaosha/zuul2.png" alt="zuul2.png"></p><p>将原来的 <a target="_blank" rel="noopener" href="http://localhost:6001/getStockStorage/26816294479">http://localhost:6001/getStockStorage/26816294479</a></p><p>改为<a target="_blank" rel="noopener" href="http://localhost/leyouStorage/getStockStorage/26816294479">http://localhost/leyouStorage/getStockStorage/26816294479</a></p><h2 id="4-8-创建页面服务（端口号3000）"><a href="#4-8-创建页面服务（端口号3000）" class="headerlink" title="4.8. 创建页面服务（端口号3000）"></a>4.8. 创建页面服务（端口号3000）</h2><hr><h3 id="4-8-1-创建页面服务"><a href="#4-8-1-创建页面服务" class="headerlink" title="4.8.1. 创建页面服务"></a>4.8.1. 创建页面服务</h3><p>第一步：选择File-New-Module…，弹出的窗口中选择Spring initializr，选择Module SDK，选择Next</p><p><img src="/2021/01/07/miaosha/EurekaServer.png" alt="EurekaServer.png"></p><p>第二步：Group为com.itheima，Artifact为leyou，Name为leyouClient，Description为Client For leyou Project，选择Next</p><p><img src="/2021/01/07/miaosha/leyouClient1.png" alt="leyouClient1.png"></p><p>第三步：选择 Web，选择 Spring Web Starter，选择Next</p><p><img src="/2021/01/07/miaosha/leyouClient2.png" alt="leyouClient.png"></p><p>第四步：Module name 为 leyouClient，Content root为路径+leyouClient，选择Finish，此时在项目文件夹下会创建一个 leyouClient文件夹</p><p><img src="/2021/01/07/miaosha/leyouClient3.png" alt="leyouClient3.png"></p><h3 id="4-8-2-配置pom-xml"><a href="#4-8-2-配置pom-xml" class="headerlink" title="4.8.2. 配置pom.xml"></a>4.8.2. 配置pom.xml</h3><p>在生成的项目中，打开pom.xml，配置依赖，其中spring-cloud-starter-netflix-eureka-client为项目引入了Eureka客户端的jar包，spring-boot-starter-web引入了web场景下，web模块开发所用到的jar包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>leyouClient<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在pom.xml中的build标签中必须加入以下资源包，否则访问页面会报404，原因是SpringBoot必须先指定路径，然后编译成功再启动，才可以访问页面</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">&lt;!-- 必须引入以下资源包才可以解决 jsp404 的问题 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">      </span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 指定resources插件处理哪个目录下的资源文件 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/webapp<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!--注意此次必须要放在此目录下才能被访问到 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>resources<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 解决 jsp404 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/01/07/miaosha/MavenImport.png" alt="MavenImport.png"></p><h3 id="4-8-3-配置文件application-properties"><a href="#4-8-3-配置文件application-properties" class="headerlink" title="4.8.3. 配置文件application.properties"></a>4.8.3. 配置文件application.properties</h3><p>在生成的项目中，打开src\man\resources\application.properties，配置端口号等</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">3000</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-client</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br></pre></td></tr></table></figure><p>在生成的项目中，打开src\main\java\com.itheima.leyou\leyouClientApplication，在已经生成的启动类中加入 @EnableEurekaClient，意思为启动Eureka客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(ClientApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试运行页面服务，在Eureka注册中心中可以看到 leyou-client服务，证明服务启动成功</p><p><img src="/2021/01/07/miaosha/eurekaClient.png" alt="eurekaClient.png"></p><h3 id="4-8-4-创建页面文件夹"><a href="#4-8-4-创建页面文件夹" class="headerlink" title="4.8.4. 创建页面文件夹"></a>4.8.4. 创建页面文件夹</h3><p>1、 在main下创建webapp文件夹</p><p>2、在webapp文件夹下创建page文件夹，用来存放html页面文件</p><p>3、在webapp文件夹下创建resources文件夹，用来存入引入的插件，这里用到的是bootstrap和jquery，bootstrap主要是页面的样式，jquery主要是使用ajax与后台交互。</p><h3 id="4-8-5-引入bootstrap"><a href="#4-8-5-引入bootstrap" class="headerlink" title="4.8.5. 引入bootstrap"></a>4.8.5. 引入bootstrap</h3><p>将bootstrap-4.3.1-dist文件夹复制到resources文件夹下</p><p>将jquery文件夹复制到resources文件夹下</p><p><img src="/2021/01/07/miaosha/webhtml.png" alt="webhtml.png"></p><h3 id="4-8-6-创建会员登录页面（loginPage-html）"><a href="#4-8-6-创建会员登录页面（loginPage-html）" class="headerlink" title="4.8.6. 创建会员登录页面（loginPage.html）"></a>4.8.6. 创建会员登录页面（loginPage.html）</h3><p>用途：用于会员注册、会员登录</p><p>将loginPage.html复制到 main\webapp\page\文件夹下</p><h3 id="4-8-7-创建商品列表页面（stockListPage-html）"><a href="#4-8-7-创建商品列表页面（stockListPage-html）" class="headerlink" title="4.8.7. 创建商品列表页面（stockListPage.html）"></a>4.8.7. 创建商品列表页面（stockListPage.html）</h3><p>用途：用于展示商品列表</p><p>将stockListPage.html复制到 main\webapp\page\文件夹下</p><h3 id="4-8-8-创建商品详情页面（stockDetailPage-html）"><a href="#4-8-8-创建商品详情页面（stockDetailPage-html）" class="headerlink" title="4.8.8. 创建商品详情页面（stockDetailPage.html）"></a>4.8.8. 创建商品详情页面（stockDetailPage.html）</h3><p>用途：用于展示商品详情</p><p>将stockDetailPage.html复制到 main\webapp\page\文件夹下</p><h3 id="4-8-9-创建订单页面（createOrderPage-html）"><a href="#4-8-9-创建订单页面（createOrderPage-html）" class="headerlink" title="4.8.9. 创建订单页面（createOrderPage.html）"></a>4.8.9. 创建订单页面（createOrderPage.html）</h3><p>用途：用于提交订单</p><p>将createOrderPage.html复制到 main\webapp\page\文件夹下</p><h3 id="4-8-8-创建支付页面（payPage-html）"><a href="#4-8-8-创建支付页面（payPage-html）" class="headerlink" title="4.8.8. 创建支付页面（payPage.html）"></a>4.8.8. 创建支付页面（payPage.html）</h3><p>用途：用于支付订单</p><p>将payPage.html复制到 main\webapp\page\文件夹下</p><h3 id="4-8-8-创建秒杀政策页面（limitPolicyPage-html）"><a href="#4-8-8-创建秒杀政策页面（limitPolicyPage-html）" class="headerlink" title="4.8.8. 创建秒杀政策页面（limitPolicyPage.html）"></a>4.8.8. 创建秒杀政策页面（limitPolicyPage.html）</h3><p>用途：用于秒杀政策添加</p><p>将limitPolicyPage.html复制到 main\webapp\page\文件夹下</p><h2 id="4-9-创建配置服务（端口号2000）"><a href="#4-9-创建配置服务（端口号2000）" class="headerlink" title="4.9. 创建配置服务（端口号2000）"></a>4.9. 创建配置服务（端口号2000）</h2><hr><h3 id="4-9-1-创建配置服务"><a href="#4-9-1-创建配置服务" class="headerlink" title="4.9.1 创建配置服务"></a>4.9.1 创建配置服务</h3><p>第一步：选择File-New-Module…，弹出的窗口中选择Spring initializr，选择Module SDK，选择Next</p><p><img src="/2021/01/07/miaosha/EurekaServer.png" alt="EurekaServer.png"></p><p>第二步：Group为com.itheima，Artifact为leyou，Name为leyouClient，Description为Client For leyou Project，选择Next</p><p><img src="/2021/01/07/miaosha/eurekaconfig1.png" alt="eurekaconfig1.png"></p><p>第三步：选择 Spring Cloud Discovery，选择 Eureka Discovery Client，选择Next</p><p><img src="/2021/01/07/miaosha/eurekaconfig2.png" alt="eurekaconfig2.png"></p><p>第四步：Module name 为 leyouConfig，Content root为路径+leyouConfig，选择Finish，此时在项目文件夹下会创建一个 leyouConfig文件夹</p><p><img src="/2021/01/07/miaosha/eurekaconfig3.png" alt="eurekaconfig3.png"></p><h3 id="4-9-2-ConfigServer配置"><a href="#4-9-2-ConfigServer配置" class="headerlink" title="4.9.2. ConfigServer配置"></a>4.9.2. ConfigServer配置</h3><p>在生成的项目中，打开pom.xml，配置依赖，其中spring-cloud-starter-netflix-eureka-client为项目引入了Eureka客户端的jar包，spring-boot-starter-web引入了web场景下，web模块开发所用到的jar包，spring-cloud-config-server引入了配置服务器所用到的jar包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>leyouConfig<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/01/07/miaosha/MavenImport.png" alt="MavenImport.png"></p><p>在src\man\resources文件夹下新增shared文件夹，用于存放各个服务的配置文件</p><p><img src="/2021/01/07/miaosha/configserver.png" alt="configserver.png"></p><h3 id="4-9-3-配置文件application-properties"><a href="#4-9-3-配置文件application-properties" class="headerlink" title="4.9.3. 配置文件application.properties"></a>4.9.3. 配置文件application.properties</h3><p>在生成的项目中，打开src\man\resources\application.properties，配置端口号等</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">2000</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-config-server</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br><span class="line"><span class="meta">spring.cloud.config.server.native.search-locations</span>=<span class="string">classPath:/shared</span></span><br><span class="line"><span class="meta">spring.cloud.config.profile</span>=<span class="string">dev</span></span><br><span class="line"><span class="meta">spring.profiles.active</span>=<span class="string">native</span></span><br></pre></td></tr></table></figure><p>在src\man\resources下新建一个shared文件夹</p><p><strong>注意：在application.properties中spring.cloud.config.server.native.search-locations这一项指的是查找本地文件路径，指向shared中，实际项目中大部分软件公司这一项可能在某台服务器上或者远程仓库。</strong></p><p><strong>share文件夹里文件的命名规则为：各个服务配置文件中spring.application.name+配置服务的application.properties文件中的spring.cloud.config.profile值的内容。</strong></p><p><strong>例如：leyou-time-server是时间服务（leyouTimeServer）的spring.application.name，配置服务的application.properties文件中的spring.cloud.config.profile为dev，所以对于商品服务的配置文件名字是 leyou-time-server-dev.properties</strong></p><p>leyou-time-server-dev.properties配置内容：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8000</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-time-server</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在生成的项目中，打开src\main\java\com.itheima.leyou\leyouConfigApplication，在已经生成的启动类中加入 @EnableEurekaClient，意思为启动Eureka客户端，并加入@EnableConfigServer，意思为启动Config配置服务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(ConfigApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以商品服务为例：</p><p>时间服务增加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>将原商品服务配置文件main/resources/application.properties里的内容挂起，新建一个bootstrap.properties文件，代码如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-time-server</span></span><br><span class="line"><span class="meta">spring.cloud.config.profile</span>=<span class="string">dev</span></span><br><span class="line"><span class="meta">spring.cloud.config.uri</span>=<span class="string">http://localhost:2000</span></span><br><span class="line"><span class="meta">spring.cloud.config.label</span>=<span class="string">master</span></span><br><span class="line"><span class="meta">spring.profiles.active</span>=<span class="string">dev</span></span><br></pre></td></tr></table></figure><p>测试运行配置服务和商品服务，在Eureka注册中心中可以看到 leyou-config-server以及leyou-stock服务，证明服务配置成功</p><p><img src="/2021/01/07/miaosha/configserver1.png" alt="configserver1.png"></p><h3 id="4-9-4-优先找配置文件原则"><a href="#4-9-4-优先找配置文件原则" class="headerlink" title="4.9.4. 优先找配置文件原则"></a>4.9.4. 优先找配置文件原则</h3><p>修改时间服务（leyouTimeServer）的application.properties配置文件</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8001</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">leyou-time-server</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:9000/eureka/</span></span><br></pre></td></tr></table></figure><p><strong>注意：这里端口号改成8001</strong></p><p>启动配置服务，再启动时间服务，控制台可以看到启动的是<strong>8000</strong></p><p><img src="/2021/01/07/miaosha/configtest1.png" alt="configtest1.png"></p><p>不启动配置服务，再启动时间服务，控制台可以看到启动的是<strong>8001</strong></p><p><img src="/2021/01/07/miaosha/configtest2.png" alt="configtest2.png"></p><p>结论：服务启动时，优先找bootstrap.properties，如果找不到，再找application.properties，证明bootstrap比application的优先级要高。</p><h1 id="五、项目测试"><a href="#五、项目测试" class="headerlink" title="五、项目测试"></a>五、项目测试</h1><h2 id="5-1-新建秒杀政策"><a href="#5-1-新建秒杀政策" class="headerlink" title="5.1. 新建秒杀政策"></a>5.1. 新建秒杀政策</h2><p>地址：<a target="_blank" rel="noopener" href="http://localhost/leyouClient/page/limitPolicyPage.html">http://localhost/leyouClient/page/limitPolicyPage.html</a></p><p><img src="/2021/01/07/miaosha/limitpolicyPage.png" alt="limitpolicyPage.png"></p><p>选择商品，输入秒杀价格、秒杀库存、开始时间、结束时间，点保存。</p><p><img src="/2021/01/07/miaosha/limitpolicyPage2.png" alt="limitPolicypage2.png"></p><h2 id="5-2-登录页面"><a href="#5-2-登录页面" class="headerlink" title="5.2. 登录页面"></a>5.2. 登录页面</h2><p>地址：<a target="_blank" rel="noopener" href="http://localhost/leyouClient/page/loginPage.html">http://localhost/leyouClient/page/loginPage.html</a></p><p><img src="/2021/01/07/miaosha/login.png" alt="login"></p><h2 id="5-3-商品列表页"><a href="#5-3-商品列表页" class="headerlink" title="5.3. 商品列表页"></a>5.3. 商品列表页</h2><p>在登录页中输入手机号，密码，跳转商品列表页</p><p>地址：<a target="_blank" rel="noopener" href="http://localhost/leyouClient/page/stockListPage.html">http://localhost/leyouClient/page/stockListPage.html</a></p><p><img src="/2021/01/07/miaosha/stocklist.png" alt="stocklist.png"></p><h2 id="5-4-商品详情页"><a href="#5-4-商品详情页" class="headerlink" title="5.4. 商品详情页"></a>5.4. 商品详情页</h2><p>在商品列表页中选择一个商品</p><p>地址：<a target="_blank" rel="noopener" href="http://localhost/leyouClient/page/stockDetailPage.html?sku_id=27359021557">http://localhost/leyouClient/page/stockDetailPage.html?sku_id=27359021557</a></p><p><img src="/2021/01/07/miaosha/stockpage.png" alt="stockpage.png"></p><h2 id="5-5-提交订单"><a href="#5-5-提交订单" class="headerlink" title="5.5. 提交订单"></a>5.5. 提交订单</h2><p>在商品详情页中点击【立即抢购】</p><p>地址：<a target="_blank" rel="noopener" href="http://localhost/leyouClient/page/createOrderPage.html?sku_id=27359021557">http://localhost/leyouClient/page/createOrderPage.html?sku_id=27359021557</a></p><p><img src="/2021/01/07/miaosha/createorderpage.png" alt="createorderpage.png"></p><h2 id="5-6-付款页面"><a href="#5-6-付款页面" class="headerlink" title="5.6. 付款页面"></a>5.6. 付款页面</h2><p>在提交订单页面点击【提交订单】</p><p>地址：<a target="_blank" rel="noopener" href="http://localhost/leyouClient/page/payPage.html?order_id=1565061554849">http://localhost/leyouClient/page/payPage.html?order_id=1565061554849</a></p><p><img src="/2021/01/07/miaosha/paypage.png" alt="payPage.png"></p><p>点击【微信支付】，提示“支付成功”</p><p><img src="/2021/01/07/miaosha/paysuccess.png" alt="paysuccess.png"></p><p>关于队列</p><p><img src="/2021/01/07/miaosha/orderqueue.png" alt="orderqueue.png"></p><p><img src="/2021/01/07/miaosha/storagequeue.png" alt="storagequeue.png"></p><h1 id="六、关于面试"><a href="#六、关于面试" class="headerlink" title="六、关于面试"></a>六、关于面试</h1><h2 id="6-1-以前做过什么项目？"><a href="#6-1-以前做过什么项目？" class="headerlink" title="6.1. 以前做过什么项目？"></a>6.1. 以前做过什么项目？</h2><p>答：商城项目、商城秒杀系统，整个商城项目中秒杀是其中最关键的一个营销活动，所以独立出来成为一个系统。秒杀系统就是我主做的。</p><h2 id="6-2-项目上线了吗？外网能否访问？"><a href="#6-2-项目上线了吗？外网能否访问？" class="headerlink" title="6.2. 项目上线了吗？外网能否访问？"></a>6.2. 项目上线了吗？外网能否访问？</h2><p>答：已经上线了，但是我们是外包公司，项目开发完之后布署到哪里不太清楚，所以不知道如何访问。</p><h2 id="6-3-项目收益是多少？"><a href="#6-3-项目收益是多少？" class="headerlink" title="6.3. 项目收益是多少？"></a>6.3. 项目收益是多少？</h2><p>答：由于是开发人员，收益这一块都是产品那边在管，所以对于开发人员来说这个不太清楚</p><h2 id="6-4-项目团队中有多少人？怎样分工？"><a href="#6-4-项目团队中有多少人？怎样分工？" class="headerlink" title="6.4. 项目团队中有多少人？怎样分工？"></a>6.4. 项目团队中有多少人？怎样分工？</h2><p>答：团队中有10个人，1个设计师，6个java开发，1个前端，2个测试。我在6人的开发团队中负责整体架构及部分代码，一般都是设计师写好概要设计，其中包含需求调研说明，项目背景，操作流程，使用技术架构，架构图。我们开发再完善详细设计，其中包含表结构，每个微服务能处理的业务，甚至还会写一些伪代码。前端负责页面开发，我们开发出来的版本交给测试人员进行测试，最终交付。</p><h2 id="6-5-项目中遇到了什么样的问题？是怎么解决的？"><a href="#6-5-项目中遇到了什么样的问题？是怎么解决的？" class="headerlink" title="6.5. 项目中遇到了什么样的问题？是怎么解决的？"></a>6.5. 项目中遇到了什么样的问题？是怎么解决的？</h2><p>答：</p><p>1、技术架构方面：刚开始的时候本来使用的是数据库来控制超买超卖，但是效率上有很大的问题，因为我们在压力测试的时候，数据库会造成很多死锁，前端页面就会没有响应。后来我们采用了redis缓存技术来解决超买超卖的问题，将秒杀的商品及库存全部存到redis里，然后秒杀一个减一个，都在缓存里处理，这样就有效的解决了效率问题。</p><p>2、开发方面：我在开发库存那一块代码的时候，库存总是减不成功，于是我先查看控制台日志，看是否有报错，然后分析，最后打断点，一行一行跟踪代码找到问题。</p><p>3、与前端的交互方面：我们提供的接口，前端那边接收到的数据解析不出来，这就需要我们输出一下我们提供接口返回的数据，看是否是有乱码，或者格式不对，字段不对等问题，也需要和前端一起联调。</p><p>4、测试方面：测试人员在提供测试报告之后，有一些问题很难重现，首先需要用他们的数据进行模拟，看是否是数据问题，其次是用他们的环境进行跟踪代码，看能否找到问题。</p><h2 id="6-6-分布式事务是如何处理的？"><a href="#6-6-分布式事务是如何处理的？" class="headerlink" title="6.6. 分布式事务是如何处理的？"></a>6.6. 分布式事务是如何处理的？</h2><p>答：分布式事务是通过 TCC 模式进行处理，比如订单和库存服务，订单服务和库存服务在开启事务之后先是执行 try 的逻辑，大家都没问题了，订单服务执行业务代码，然后执行confirm的逻辑，库存也执行业务代码，然后执行comfirm的逻辑，大家一起提交。如果库存服务 try 的逻辑执行失败时，会通知订单服务执行 cancel 的逻辑。</p><p>在大家都没问题的情况下，try要进行一次交互，然后 confirm 再进行一次交互，所以协调完两个服务会有成本。量小的时候没问题，但是量一旦很大的时候，这样就会造成排队现象。</p><p>所以我们没有使用分布式事务处理多个微服务之间的事务问题，我们先是通过redis来处理前端的请求，然后把业务进行拆分，拆分的业务使用消息队列中间件来解决，每个服务都开启自己的事务处理业务，这样可以更加高效的解决并发。</p><h2 id="6-7-项目开发用了多久？"><a href="#6-7-项目开发用了多久？" class="headerlink" title="6.7. 项目开发用了多久？"></a>6.7. 项目开发用了多久？</h2><p>答：前期的调研加概要设计大概用了10天，我们补充详细设计大概是5天，开发用时在20天左右的时间，加上测试，联调，解决bug，复测，上线应该在1个半月左右。</p><h2 id="6-8-项目中用到了哪些技术？"><a href="#6-8-项目中用到了哪些技术？" class="headerlink" title="6.8. 项目中用到了哪些技术？"></a>6.8. 项目中用到了哪些技术？</h2><p>答：用的是SpringCloud微服务架构，主要解决后台服务压力过大的问题，所以根据不同模块进行拆分，每个开发小组负责一个微服务，缓存用的redis中间件，处理业务拆分用到的是RabbitMQ。</p><h2 id="6-9-项目中的数据都是通过SQL查询的吗？"><a href="#6-9-项目中的数据都是通过SQL查询的吗？" class="headerlink" title="6.9. 项目中的数据都是通过SQL查询的吗？"></a>6.9. 项目中的数据都是通过SQL查询的吗？</h2><p>答：不完全是，比如商品取到的秒杀政策就是在redis里取的，不是通过SQL查询，而商品列表和商品详情都是通过SQL查询的。还有控制秒杀的数量都是在redis里进行控制的，而不是实时用SQL查询库存。</p><h2 id="6-10-项目中你觉得哪个模块最难？"><a href="#6-10-项目中你觉得哪个模块最难？" class="headerlink" title="6.10. 项目中你觉得哪个模块最难？"></a>6.10. 项目中你觉得哪个模块最难？</h2><p>答：处理业务模块上我觉得库存模块最难，由于库存是敏感数据，操作都要非常谨慎，一旦库存出错，会给商家带来具大的损失。</p><p>如何处理大并发量是这个项目的难点，我们是通过redis控制超买超卖，通过消息队列RabbitMQ来对业务进行拆分。</p></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://bingyuchan.github.io/2021/01/07/miaosha/" title="miaosha" target="_blank" rel="external">https://bingyuchan.github.io/2021/01/07/miaosha/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/BingyuChan" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.png" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/BingyuChan" target="_blank"><span class="text-dark">BingyuChan</span><small class="ml-1x">Web Developer &amp; Designer</small></a></h3><div>程序猿，Java</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2021/01/18/Redis%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-Linux/" title="Redis集群搭建(Linux)"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2021/01/06/photo/" title="photo"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/BingyuChan" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/null" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="/null" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="/null" target="_blank" title="Behance" data-toggle="tooltip" data-placement="top"><i class="icon icon-behance"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"",appKey:"",placeholder:"Just go go",avatar:"mm",meta:meta,pageSize:"10",visitor:!1})</script></body></html>